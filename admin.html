<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BARO • Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    main { padding:2rem 1rem; max-width:900px; margin:0 auto; }
    .panel { background:var(--light, #fff); padding:1rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:1rem; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; }
    .row > * { flex:1 1 300px; }
    label { display:block; margin:.5rem 0 .25rem; font-weight:600; }
    input, select, textarea { width:100%; padding:.6rem; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
    button { background:var(--accent); color:#fff; border:none; border-radius:6px; padding:.6rem 1rem; cursor:pointer; }
    button.secondary { background:#444; }
    .muted { color:#555; font-size:.9rem; }
    .error { color:#b00020; font-weight:600; }
    .hidden { display:none; }
    table th, table td { border-bottom:1px solid #e6e6e6; }
  </style>
</head>
<body>
  <!-- Reusable header -->
  <div id="header"></div>
  <script>
    fetch("header.html").then(r=>r.text()).then(html=>{ document.getElementById("header").innerHTML = html; });
  </script>

  <main>
    <h2 style="text-align:center">Admin • Add Listings</h2>

    <!-- Auth Panel -->
    <div class="panel" id="auth-panel">
      <h3>Sign in</h3>
      <p class="muted">Use your admin/lender account.</p>
      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="••••••••" />
        </div>
      </div>
      <div style="margin-top:.75rem; display:flex; gap:.5rem;">
        <button id="btn-signin">Sign in</button>
        <button id="btn-signup" class="secondary">Sign up (first time)</button>
      </div>
      <p id="auth-status" class="muted" style="margin-top:.5rem;"></p>
    </div>

    <!-- Session Panel -->
    <div class="panel hidden" id="session-panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>Signed in:</strong> <span id="whoami"></span>
          <span id="profile-state" class="muted"></span>
        </div>
        <button id="btn-signout" class="secondary">Sign out</button>
      </div>
    </div>

    <!-- Profile / quick filters -->
    <div class="profile-strip panel">
      <div class="profile-main">
        <strong id="prof-email">—</strong>
        <span id="prof-role-admin" class="badge badge-admin" style="display:none;">Admin</span>
        <span id="prof-role-lender" class="badge badge-lender" style="display:none;">Lender</span>
        <span id="prof-paused" class="badge badge-paused" style="display:none;">Global pause ON</span>
      </div>
      <div class="filters">
        <span class="pill" data-filter="all" aria-current="true">All</span>
        <span class="pill" data-filter="pending">Pending</span>
        <span class="pill" data-filter="confirmed">Confirmed</span>
        <span class="pill" data-filter="cancelled">Cancelled</span>
      </div>
    </div>

    <!-- Not authorized notice -->
    <div class="panel hidden" id="notauth-panel">
      <p class="error">You’re signed in but not authorized to create listings. Ask an admin to set your account as a lender.</p>
      <p class="muted">Tip: run the one-liner to set <code>is_admin</code> and <code>is_lender</code> for your profile.</p>
    </div>

    <!-- Add Listing -->
    <div class="panel hidden" id="add-panel">
      <h3>New Listing</h3>
      <div class="row">
        <div>
          <label for="title">Title</label>
          <input id="title" placeholder="Starlink Gen 2 Kit" />
        </div>
        <div>
          <label for="category">Category</label>
          <select id="category">
            <option>Tech</option>
            <option>Recreation</option>
            <option>Vehicles</option>
            <option>Excursions</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <label for="description">Description</label>
      <textarea id="description" rows="4" placeholder="Dish, router, cables, backpack..."></textarea>

      <div class="row">
        <div>
          <label for="price">Base price (USD per day)</label>
          <input id="price" type="number" step="0.01" placeholder="30.00" />
        </div>
        <div>
          <label for="maxMonths">Max advance booking (months)</label>
          <input id="maxMonths" type="number" min="1" max="24" value="15" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <label style="display:flex; gap:.5rem; align-items:center;">
            <input id="paused" type="checkbox" />
            Pause this listing
          </label>
        </div>
      </div>

      <div style="margin-top:1rem;">
        <button id="btn-create">Create listing</button>
        <span id="create-status" class="muted" style="margin-left:.5rem;"></span>
      </div>
    </div>

    <!-- Owner Reservations -->
    <div class="panel hidden" id="owner-res-panel">
      <h3>Reservations for your listings</h3>
      <p class="muted">Pending holds show here. Confirm after payment or cancel to free the dates.</p>
      <div id="resv-empty" class="muted">No reservations yet.</div>
      <table id="resv-table" class="hidden" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:.4rem;">Listing</th>
            <th style="text-align:left; padding:.4rem;">Dates</th>
            <th style="text-align:left; padding:.4rem;">Amount</th>
            <th style="text-align:left; padding:.4rem;">Status</th>
            <th style="text-align:left; padding:.4rem;">Actions</th>
          </tr>
        </thead>
        <tbody id="resv-body"></tbody>
      </table>
    </div>

    <p class="muted" style="text-align:center; margin-top:1rem;">
      Note: global pause and blackout controls come next.
    </p>
  </main>

  <!-- Supabase: module import -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // Your real project values
    const SUPABASE_URL = 'https://lxplphqfkdvjtphafcyt.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4cGxwaHFma2R2anRwaGFmY3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDAxOTQsImV4cCI6MjA3NTQxNjE5NH0.cRm0HrVuhEgALHiyOtlMQWMvDcFXFaBZvBOysshpzjU'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const $ = (id) => document.getElementById(id)
    const authPanel = $('auth-panel')
    const sessionPanel = $('session-panel')
    const addPanel = $('add-panel')
    const notAuth = $('notauth-panel')
    const whoami = $('whoami')
    const profileState = $('profile-state')
    const authStatus = $('auth-status')

    const ownerResPanel = $('owner-res-panel')
    const resvEmpty = $('resv-empty')
    const resvTable = $('resv-table')
    const resvBody = $('resv-body')

    const profEmailEl = document.getElementById('prof-email')

    let resvFilter = 'all'        // filter state
    let allOwnerReservations = [] // cache
    let currentUserId = null
    let currentProfile = null     // admin/lender flags

    function showSignedIn(user) {
      authPanel.classList.add('hidden')
      sessionPanel.classList.remove('hidden')
      whoami.textContent = user.email
      if (profEmailEl) profEmailEl.textContent = user.email
    }
    function showSignedOut() {
      authPanel.classList.remove('hidden')
      sessionPanel.classList.add('hidden')
      addPanel.classList.add('hidden')
      notAuth.classList.add('hidden')
      ownerResPanel.classList.add('hidden')
      authStatus.textContent = ''
      if (profEmailEl) profEmailEl.textContent = '—'
    }

    async function ensureProfile(user) {
      await supabase.from('profiles').upsert(
        { id: user.id, display_name: user.email },
        { onConflict: 'id' }
      )
    }

    // unified loadProfile (sets badges)
    async function loadProfile(user) {
      const { data, error } = await supabase
        .from('profiles')
        .select('is_admin,is_lender,paused_global,display_name')
        .eq('id', user.id)
        .single()
      if (error) { profileState.textContent = ' • profile error'; return null }

      profileState.textContent = data.paused_global ? ' • global pause ON' : ' • global pause OFF'
      document.getElementById('prof-role-admin').style.display = data.is_admin ? 'inline-block' : 'none'
      document.getElementById('prof-role-lender').style.display = data.is_lender ? 'inline-block' : 'none'
      document.getElementById('prof-paused').style.display = data.paused_global ? 'inline-block' : 'none'

      return data
    }

    function gate(profile) {
      const ok = !!(profile?.is_admin || profile?.is_lender)
      if (ok) {
        addPanel.classList.remove('hidden')
        notAuth.classList.add('hidden')
        ownerResPanel.classList.remove('hidden')
        loadOwnerReservations()
      } else {
        addPanel.classList.add('hidden')
        notAuth.classList.remove('hidden')
        ownerResPanel.classList.add('hidden')
      }
    }

    // helpers
    const fmtDate  = d => new Date(d).toLocaleDateString()
    const fmtMoney = c => `$${(c/100).toFixed(2)}`
    const labelFor = role => role === 'admin' ? 'Baro' : role === 'owner' ? 'Lender' : role === 'renter' ? 'Renter' : 'Unknown'

    // Load owner reservations (fetch once, then render with filter)
    async function loadOwnerReservations() {
      if (!currentUserId) return

      const { data, error } = await supabase
        .from('reservations')
        .select('id, start_date, end_date, amount_cents, status, cancelled_at, cancelled_by_role, cancel_notes, listing_id, listings!inner(title, owner_id)')
        .eq('listings.owner_id', currentUserId)
        .order('created_at', { ascending:false })

      if (error) {
        resvEmpty.textContent = 'Error loading reservations.'
        resvTable.classList.add('hidden')
        return
      }

      allOwnerReservations = data || []
      renderOwnerReservations()
    }

    function renderOwnerReservations() {
      const list = resvFilter === 'all'
        ? allOwnerReservations
        : allOwnerReservations.filter(r => r.status === resvFilter)

      if (!list.length) {
        resvEmpty.textContent = 'No reservations to display.'
        resvTable.classList.add('hidden')
        resvBody.innerHTML = ''
        return
      }
      resvEmpty.textContent = ''
      resvTable.classList.remove('hidden')
      resvBody.innerHTML = ''

      const chip = (txt, bg, fg, brd='#0000') =>
        `<span style="background:${bg};color:${fg};border:1px solid ${brd};border-radius:999px;padding:.2rem .5rem;font-weight:700;">${txt}</span>`
      const pendingChip   = chip('pending',   '#fff7e6', '#b36b00', '#ffd188')
      const confirmedChip = chip('confirmed', '#e6ffed', '#0a6',    '#b5f0c5')

      for (const r of list) {
        const isCancelled = r.status === 'cancelled'
        const isConfirmed = r.status === 'confirmed'

        const cancelledBanner = `
          <div class="banner-cancel">
            Cancelled${r.cancelled_by_role ? ` by ${labelFor(r.cancelled_by_role)}` : ''}
            ${r.cancelled_at ? ` • ${new Date(r.cancelled_at).toLocaleString()}` : ''}
            ${r.cancel_notes ? `<small>“${String(r.cancel_notes).replace(/</g,'&lt;')}”</small>` : ''}
          </div>`

        const roleOptions = currentProfile?.is_admin
          ? `<option value="admin" selected>Baro</option><option value="owner">Lender</option><option value="renter">Renter</option>`
          : `<option value="owner" selected>Lender</option>`

        const statusCell = isCancelled ? '—' : (isConfirmed ? confirmedChip : pendingChip)
        const actionsCell = isCancelled
          ? cancelledBanner
          : isConfirmed
            ? `
                <div style="display:flex;flex-direction:column;gap:.4rem;">
                  <div>${confirmedChip}</div>
                  <div style="display:flex;align-items:center;gap:.5rem;">
                    <select class="cancel-as" style="margin-right:.4rem">${roleOptions}</select>
                    <button class="cancel secondary" data-id="${r.id}">Cancel</button>
                  </div>
                </div>`
            : `
                <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
                  <button class="confirm" data-id="${r.id}">Confirm</button>
                  <select class="cancel-as" style="margin-left:.2rem">${roleOptions}</select>
                  <button class="cancel secondary" data-id="${r.id}">Cancel</button>
                </div>`

        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td style="padding:.4rem;">${r.listings?.title || 'Listing #'+r.listing_id}</td>
          <td style="padding:.4rem;">${fmtDate(r.start_date)} → ${fmtDate(r.end_date)}</td>
          <td style="padding:.4rem;">${fmtMoney(r.amount_cents)}</td>
          <td style="padding:.4rem;">${statusCell}</td>
          <td style="padding:.4rem;">${actionsCell}</td>
        `
        resvBody.appendChild(tr)
      }

      // wire confirm
      resvBody.querySelectorAll('button.confirm').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = parseInt(e.currentTarget.dataset.id,10)
          e.currentTarget.disabled = true
          const { error } = await supabase.from('reservations').update({ status: 'confirmed' }).eq('id', id)
          if (error) { alert('Confirm failed: ' + error.message); e.currentTarget.disabled = false; return }
          await loadOwnerReservations()
        })
      })

      // wire cancel with role + notes
      resvBody.querySelectorAll('button.cancel').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const tr = e.currentTarget.closest('tr')
          const id = parseInt(e.currentTarget.dataset.id,10)
          const role = (tr.querySelector('select.cancel-as')?.value) || (currentProfile?.is_admin ? 'admin' : 'owner')
          if (!confirm(`Cancel this reservation as ${labelFor(role)}? This frees the dates and cannot be undone.`)) return
          const notes = prompt('Add cancellation notes (optional):', '') || null

          e.currentTarget.disabled = true
          const { error } = await supabase.from('reservations').update({
            status: 'cancelled',
            cancelled_at: new Date().toISOString(),
            cancelled_by_user_id: currentUserId,
            cancelled_by_role: role,
            cancel_notes: notes
          }).eq('id', id)

          if (error) { alert('Cancel failed: ' + error.message); e.currentTarget.disabled = false; return }
          await loadOwnerReservations()
        })
      })
    }

    // filter pills
    document.querySelectorAll('.filters .pill').forEach(pill=>{
      pill.addEventListener('click', ()=>{
        document.querySelectorAll('.filters .pill').forEach(x=>x.setAttribute('aria-current','false'))
        pill.setAttribute('aria-current','true')
        resvFilter = pill.dataset.filter || 'all'
        renderOwnerReservations()
      })
    })

    // ---------- Session bootstrap ----------
    {
      const { data: { session } } = await supabase.auth.getSession()
      if (session?.user) {
        currentUserId = session.user.id
        showSignedIn(session.user)
        await ensureProfile(session.user)
        currentProfile = await loadProfile(session.user)
        gate(currentProfile)
      } else {
        showSignedOut()
      }
    }

    // ---------- Auth actions ----------
    $('btn-signin').addEventListener('click', async () => {
      const email = $('email').value.trim()
      const password = $('password').value
      authStatus.textContent = 'Signing in...'
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      authStatus.textContent = error ? `Error: ${error.message}` : 'Signed in.'
      if (!error) {
        currentUserId = data.user.id
        showSignedIn(data.user)
        await ensureProfile(data.user)
        currentProfile = await loadProfile(data.user)
        gate(currentProfile)
      }
    })

    $('btn-signup').addEventListener('click', async () => {
      const email = $('email').value.trim()
      const password = $('password').value
      authStatus.textContent = 'Creating account...'
      const { error } = await supabase.auth.signUp({ email, password })
      authStatus.textContent = error ? `Error: ${error.message}` : 'Account created. Check email to confirm, then sign in.'
    })

    $('btn-signout').addEventListener('click', async () => {
      await supabase.auth.signOut()
      currentUserId = null
      currentProfile = null
      showSignedOut()
    })

    // ---------- Create listing ----------
    $('btn-create').addEventListener('click', async () => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) { $('create-status').textContent = 'Please sign in first.'; return }

      const title = $('title').value.trim()
      const category = $('category').value
      const description = $('description').value.trim()
      const dollars = parseFloat($('price').value)
      const base_price_cents = Math.round((isNaN(dollars) ? 0 : dollars) * 100)
      const max_advance_months = parseInt($('maxMonths').value || '6', 10)
      const paused = $('paused').checked

      if (!title || base_price_cents <= 0) {
        $('create-status').textContent = 'Title and valid price required.'; return
      }

      $('create-status').textContent = 'Saving...'
      const { error } = await supabase.from('listings').insert({
        owner_id: user.id, title, description, category,
        base_price_cents, max_advance_months, paused
      })

      $('create-status').textContent = error ? `Error: ${error.message}` : 'Created ✅'
      if (!error) {
        $('title').value = ''
        $('description').value = ''
        $('price').value = ''
        $('paused').checked = false
        loadOwnerReservations()
      }
    })
  </script>
</body>
</html>
