<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BARO • Calendar</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ===== Layout & tokens ===== */
    :root{
      --pending-yellow:#ffeaa5;
      --action-red:#c52a35;
      --lender-green:#06553f;
      --renter-blue:#0a47a6;
      --promo-blue:#e1e9ff;
      --owner-amber:#ffe2c7;
      --store-rose:#ffc9c9;
      --chip-border:#d6d6d6;
      --cell-h: 170px; /* fixed row height so overlay aligns */
      --band-h: 18px;
      --band-gap: 2px;
    }
    *{ box-sizing:border-box; }
    main { max-width:1600px; margin:0 auto; padding:1.25rem 1rem 2rem; }
    .cal-wrap { display:grid; grid-template-columns: 1fr 380px; gap:1rem; align-items:start; }
    @media (max-width: 1200px){ .cal-wrap { grid-template-columns: 1fr; } }
    .left-col { display:grid; gap:.6rem; min-width: 1100px; }

    /* ===== Header ===== */
    .cal-header{ background:#fff; border:1px solid #e6e6e6; border-radius:10px; padding:.6rem; display:grid; gap:.55rem; }
    .cal-nav{ display:grid; grid-template-columns:auto 1fr auto; gap:.5rem; align-items:center; }
    .cal-title{ font-weight:800; font-size:1.35rem; text-align:center; }
    .navbtn{ border:none; background:#111; color:#fff; border-radius:10px; padding:.5rem .8rem; cursor:pointer; }

    .jump-controls{ display:grid; grid-template-columns:1fr 1fr auto auto; gap:.5rem; align-items:center; }
    .jump-controls select,
      .jump-controls .pill{
        width:100%;
        padding:.5rem .6rem;
        border:1px solid #d6d6d6;
        border-radius:8px;
        background:#fff;
      }
    .pill{ cursor:pointer; }

    /* ===== Filters ===== */
    .filters-row{ background:#fff; border:1px solid #e6e6e6; border-radius:10px; padding:.5rem; display:grid; grid-template-columns:repeat(5, minmax(120px,1fr)); gap:.5rem; }
    .filters-row[hidden]{ display:none; }
    .filter-toggle{ position:relative; display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.45rem .6rem; border-radius:10px; border:1px solid #cfcfcf; background:#f5f5f5; color:#1b1b1b; font-weight:700; cursor:pointer; user-select:none; }
    .filter-toggle .check{ width:14px; height:14px; border-radius:3px; border:1px solid #aaa; background:#fff; display:inline-grid; place-items:center; font-size:12px; line-height:1; }
    .filter-toggle[data-on="true"]{ box-shadow: inset 0 0 0 2px #0002; }
    .filter-lend[data-on="true"]  { background:#d3f3e6; color:#06553f; border-color:#76cfb1; }
    .filter-rent[data-on="true"]  { background:#d7e4ff; color:#0a47a6; border-color:#90b0ff; }
    .filter-owner[data-on="true"] { background:#ffe2c7; color:#8b5200; border-color:#ffb870; }
    .filter-store[data-on="true"] { background:#ffc9c9; color:#8f0d22; border-color:#ff9a9a; }
    .filter-pend[data-on="true"]  { background:#ffeaa5; color:#7a5f00; border-color:#ffd257; }
    .filter-toggle[data-on="true"] .check{ border-color:currentColor; }
    .filter-toggle[data-on="true"] .check::after{ content:"✓"; }

    /* ===== Calendar ===== */
    .cal { position:relative; background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); overflow:hidden; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
    #grid-days { grid-auto-rows: var(--cell-h); } /* fixed track height removes overlay drift */
    .dow { background:#f6f6f6; padding:.35rem .4rem .4rem; border-bottom:1px solid #ececec; font-weight:800; font-size:.9rem; text-align:center; min-width:150px; user-select:none; cursor:pointer; }
    .dow[aria-selected="true"]{ outline:2px solid #0b57d0; outline-offset:-2px; background:#eef6ff; }
    .dow .hrs{ display:block; margin-top:.15rem; font-weight:600; font-size:.72rem; color:#626262; pointer-events:none; }

    .day { height:var(--cell-h); border-right:1px solid #f1f1f1; border-bottom:1px solid #f1f1f1; padding:.35rem .35rem .4rem; position:relative; cursor:pointer; overflow:visible; display:flex; flex-direction:column; gap:.2rem; }
    .day:nth-child(7n) { border-right: none; }
    .date { font-weight:800; font-size:.96rem; }
    .past { background:#f4f4f4; color:#575757; }
    .today .date{ outline:2px solid #0b57d0; outline-offset:2px; border-radius:999px; padding:.1rem .35rem; }
    .clock-ico{ position:absolute; top:3px; right:4px; font-size:12px; color:#111; }

    /* Overlay bands (span multiple days) */
    .band-layer{
      position:absolute; left:0; right:0;
      pointer-events:none;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      z-index:5;
    }
.band{
  position:relative;

  /* default: include +1px on both sides to account for the 1px cell borders
     that live on the edges between grid tracks */
  padding-left:calc(.35rem + 1px);
  padding-right:calc(.35rem + 1px);
}

/* if a band STARTS in column 1, there is no left neighbor’s right border */
.band[data-col="1"]{
  padding-left:.35rem;
}

/* if a band ENDS in column 7, there is no right border to absorb */
.band[data-endcol="7"]{
  padding-right:.35rem;
}

.band .pill{
  position:absolute;
  /* fill the padded area of .band so ends stop at the cell’s inside edges */
  left:0;
  right:0;

  height:var(--band-h);
  border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  font-size:.70rem; line-height:1; padding:0 .4rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  border:2px solid transparent;
  text-transform:uppercase;
  font-weight:800;
  box-sizing:border-box;

  /* kill the global .pill width from the header controls */
  width:auto;
  max-width:100%;
}
    .band .pill .L{ color:var(--lender-green); font-weight:900; }
    .band .pill .R{ color:var(--renter-blue); font-weight:900; }

    /* stacking order (top -> bottom): pending START, promo, confirmed L, pending END, confirmed R, owner, store */
    /* --- Pending START/END single-day bars (no duration bands for pending) --- */
.band.pstart .pill,
.band.pendend .pill{
  background: var(--pending-yellow);
  border: 2px solid var(--action-red);
  color: #111;                 /* overridden below by role classes */
  text-transform: uppercase;
  font-weight: 800;
}

/* role text color */
.band.pstart.roleL  .pill,
.band.pendend.roleL .pill { color: var(--lender-green); }  /* lender = green */

.band.pstart.roleR  .pill,
.band.pendend.roleR .pill { color: var(--renter-blue); }   /* renter = blue */

/* 7-lane vertical order (top → bottom) */
.band.pstart   .pill { bottom: calc(var(--band-h) * 6 + var(--band-gap) * 7); }  /* PENDING START */
.band.promo    .pill { bottom: calc(var(--band-h) * 5 + var(--band-gap) * 6); }
.band.confL    .pill { bottom: calc(var(--band-h) * 4 + var(--band-gap) * 5); }
.band.pendend  .pill { bottom: calc(var(--band-h) * 3 + var(--band-gap) * 4); }  /* PENDING END */
.band.confR    .pill { bottom: calc(var(--band-h) * 2 + var(--band-gap) * 3); }
.band.owner    .pill { bottom: calc(var(--band-h) * 1 + var(--band-gap) * 2); }
.band.store    .pill { bottom: calc(var(--band-h) * 0 + var(--band-gap) * 1); }

/* lane-aware stacking when L and R both exist in the same lane */
/* Top lane (PENDING START): push the second pill DOWN so it stays inside the cell */
.band.pstart[data-stack="1"] .pill {
  transform: translateY(calc(var(--band-h) + var(--band-gap)));
}

/* Lower pending lane (PENDING END): push the second pill UP so it sits above its mate */
.band.pendend[data-stack="1"] .pill {
  transform: translateY(calc(-1 * (var(--band-h) + var(--band-gap))));
}

    /* Pending chips for starts/ends inside cells (honor filters) */
    .chips { display:flex; flex-direction:column; gap:.18rem; max-height:56px; overflow:hidden; }
    .chip  { display:inline-flex; align-items:center; gap:.28rem; font-size:.72rem; line-height:1.05; border-radius:5px; padding:.10rem .28rem; width:max-content; border:2px solid var(--action-red); background:var(--pending-yellow); font-weight:800; text-transform:uppercase; color:#111;}
    .chip .L{ color:var(--lender-green); }
    .chip .R{ color:var(--renter-blue); }
    .chip-more{ background:#e7e7e7; color:#4a4a4a; border:1px solid #d0d0d0; text-transform:none; font-weight:600; }
    .sel { outline:2px solid #0b57d0; outline-offset:-2px; background:#eef6ff; }

    /* ===== Side panel (sticky with internal scroll) ===== */
    .panel {
            background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:1rem;
      /* fixed in-flow panel, no internal scroll; height is synced to calendar via JS */
      position:relative; top:auto; max-height:none; overflow:visible; height:auto;
    }
    .panel h3{ margin:.2rem 0 .4rem; }
    .vgap { display:grid; gap:.6rem; }
    .btn-full { width:100%; }
    .btn { background:#111; color:#fff; border:none; cursor:pointer; border-radius:8px; padding:.55rem .6rem; }
    .btn.orange { background:#8f5200; }
    .btn.gold   { background:#8c6a00; }
    .btn.red    { background:#8f0d22; }
    .btn.green  { background:#1b7d33; }
    .btn.blue   { background:#0b57d0; }
    .btn.gray   { background:#4d5563; }
    .btn.white  { background:#fff; color:#111; border:1px solid #d6d6d6; }
    .hint { font-size:.9rem; color:#565656; }
    .banner { padding:.5rem .6rem; border-radius:8px; background:#fff7e6; color:#9a5a00; border:1px solid #ffd188; margin-bottom:.5rem; }

    .dow-compact{ display:none; }

    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
    .row2-inline{ display:grid; grid-template-columns:1fr 1fr auto auto; gap:.5rem; align-items:end; }
    .time { width:100%; padding:.45rem .5rem; border:1px solid #d6d6d6; border-radius:8px; background:#fff; }

    /* Agenda (full width below) */
    .agenda { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:1rem; margin-top:1rem; }
    .agenda h4{ margin:.2rem 0 .4rem; }
    .agenda .subtitle{ margin:.1rem 0 .6rem; color:#666; font-size:.92rem; }
    .agenda-section{ margin:.6rem 0 .3rem; font-weight:800; }
    .agenda-item{ margin:.2rem 0 .35rem; padding:.35rem .5rem; border:1px solid #eee; border-radius:8px; }
    .agenda-item .warn{ color:#a40019; font-weight:800; text-transform:uppercase; }

    .muted { color:#666; font-size:.9rem; }
    .tiny-btn { background:none; border:none; color:#0b57d0; cursor:pointer; padding:0; font-size:.86rem; }
    .w-full{ width:100%; }
    .stack-gap{ display:grid; gap:.5rem; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <!-- header -->
  <div id="header"></div>
  <script>
    (async () => {
      const host = document.getElementById('header');
      try {
        const res = await fetch('./header.html', { cache:'no-store' });
        if (!res.ok) throw new Error('Failed to load header');
        host.innerHTML = await res.text();
        const boot = () => window.initHero && window.initHero();
        if (document.readyState === 'complete') boot();
        else addEventListener('load', boot);
      } catch (err) {
        console.error('Header load failed:', err);
        host.innerHTML = '<p style="color:red;text-align:center;">Header failed to load</p>';
      }
    })();
  </script>

  <main>
    <div class="cal-wrap">
      <div class="left-col">
        <!-- calendar header -->
        <section class="cal-header">
          <div class="cal-nav">
            <button class="navbtn" id="prev" aria-label="Previous month">←</button>
            <div class="cal-title" id="title">Calendar</div>
            <button class="navbtn" id="next" aria-label="Next month">→</button>
          </div>
          <div class="jump-controls">
            <select id="jump-month" aria-label="Jump to month">
              <option value="0">January</option><option value="1">February</option><option value="2">March</option>
              <option value="3">April</option><option value="4">May</option><option value="5">June</option>
              <option value="6">July</option><option value="7">August</option><option value="8">September</option>
              <option value="9">October</option><option value="10">November</option><option value="11">December</option>
            </select>
            <select id="jump-year" aria-label="Jump to year"></select>
            <button class="pill" id="jump-today" type="button" title="Jump to current month">Today</button>
            <button class="pill" id="toggle-filters" type="button" aria-expanded="false" aria-controls="filters">Filters</button>
          </div>
        </section>

        <!-- filters -->
        <div class="filters-row" id="filters" hidden>
          <button type="button" class="filter-toggle filter-lend"  data-key="lend"  data-on="true" aria-pressed="true"><span class="check"></span> Lender obligations</button>
          <button type="button" class="filter-toggle filter-rent"  data-key="rent"  data-on="true" aria-pressed="true"><span class="check"></span> Your rentals</button>
          <button type="button" class="filter-toggle filter-owner" data-key="owner" data-on="true" aria-pressed="true"><span class="check"></span> Owner unavailable</button>
          <button type="button" class="filter-toggle filter-store" data-key="store" data-on="true" aria-pressed="true"><span class="check"></span> Store blocked</button>
          <button type="button" class="filter-toggle filter-pend"  data-key="pending" data-on="true" aria-pressed="true"><span class="check"></span> Pending reservations</button>
        </div>

        <!-- calendar -->
        <section class="cal" id="cal">
          <div class="cal-grid" id="grid-dow"></div>
          <div class="cal-grid" id="grid-days"></div>
          <div class="band-layer" id="band-layer" aria-hidden="true"></div>
        </section>
      </div>

      <!-- tools -->
      <aside class="panel" id="manage">
        <div id="blk-banner" class="banner" style="display:none;"></div>

        <!-- Pending quick action -->
        <button class="btn blue btn-full" id="btn-view-pending">View pending reservations (<span id="pending-count">0</span>)</button>

        <!-- Range picker -->
        <div class="stack-gap" style="margin-top:.5rem;">
          <label style="font-weight:700;">Date range</label>
          <div class="row2">
            <input type="date" id="range-from" class="w-full" />
            <input type="date" id="range-to" class="w-full" />
          </div>
          <div class="row2">
            <button class="btn white" id="btn-select-range">Select range</button>
            <label class="muted" style="display:flex;align-items:center;gap:.4rem;">
              <input type="checkbox" id="repeat-annually" /> Repeat annually (for seasonal closures)
            </label>
          </div>
        </div>

        <!-- HOURS -->
        <div class="stack-gap" style="margin-top:1rem;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:.2rem 0;">Shop hours</h3>
            <button id="btn-refresh-weekly" class="tiny-btn" title="Reload weekly hours">↻</button>
          </div>
          <div class="muted">Tip: selecting midnight to midnight acts as 24 hours. Or use the checkboxes.</div>

          <div class="row2-inline">
            <div>
              <label>Open</label>
              <select class="time" id="hrs-open"></select>
            </div>
            <div>
              <label>Close</label>
              <select class="time" id="hrs-close"></select>
            </div>
            <label class="muted" style="display:flex;gap:.35rem;align-items:center;"><input type="checkbox" id="chk-24h"> 24 hours</label>
            <label class="muted" style="display:flex;gap:.35rem;align-items:center;"><input type="checkbox" id="chk-closed"> Closed</label>
          </div>

          <button class="btn green btn-full" id="btn-set-hours">Set hours</button>
          <button class="btn blue btn-full hidden" id="btn-remove-overrides">Remove custom hours on selected dates</button>
        </div>

        <h3 style="margin-top:1rem;">Shop-wide tools</h3>
        <p class="hint">Use your selection (click cells or the date range above). With “Repeat annually,” Unavailable or Blocked writes a seasonal rule and materializes the next 15 months.</p>

        <div class="vgap">
          <div>
            <label>Availability</label>
            <div class="row2">
              <button class="btn orange" id="btn-unavail-add">Mark unavailable</button>
              <button class="btn gold"   id="btn-unavail-remove">Mark available</button>
            </div>
          </div>

          <div>
            <label>Store recall</label>
            <div class="row2">
              <button class="btn red"   id="btn-block-add">Block all rentals</button>
              <button class="btn green" id="btn-block-remove">Remove block</button>
            </div>
          </div>

          <div>
            <label>Promotions</label>
            <div class="row2">
              <button class="btn blue" id="btn-promo-add">Add promotion</button>
              <button class="btn gray" id="btn-promo-remove">Remove promotion</button>
            </div>
          </div>

          <button class="btn white btn-full" id="btn-clear">Deselect all dates</button>
        </div>
      </aside>
    </div>

    <!-- agenda now spans full width under the two columns -->
    <section class="agenda" id="agenda">
      <h4 id="agenda-title">A peek at the week</h4>
      <div id="agenda-sub" class="subtitle"></div>
      <div id="agenda-body"></div>
    </section>
  </main>

  <!-- promo modal -->
  <dialog class="modal" id="promo-modal">
    <form method="dialog" id="promo-form">
      <h3 style="margin:.25rem 0;">Add promotional pricing</h3>
      <div class="row2">
        <div>
          <label>Discount type</label>
          <select id="promo-type"><option value="percent">% off</option><option value="flat">$ off per day</option></select>
        </div>
        <div>
          <label>Applies to</label>
          <input value="All owned listings" disabled style="width:100%; padding:.55rem .6rem; border:1px solid #eee; border-radius:8px; background:#fafafa; color:#333;">
        </div>
      </div>
      <div class="row2">
        <div><label>Range start</label><input type="date" id="promo-start" required /></div>
        <div><label>Range end</label><input type="date" id="promo-end" required /></div>
      </div>
      <div class="row2">
        <div>
          <label>Tier 1</label>
          <input id="t1-value" type="number" step="0.01" placeholder="10" />
          <div class="muted">Min days <input id="t1-min" type="number" min="1" style="width:5em"> Max <input id="t1-max" type="number" min="1" style="width:5em"></div>
        </div>
        <div>
          <label>Tier 2</label>
          <input id="t2-value" type="number" step="0.01" placeholder="20" />
          <div class="muted">Min days <input id="t2-min" type="number" min="1" style="width:5em"> Max <input id="t2-max" type="number" min="1" style="width:5em"></div>
        </div>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.4rem;">
        <button value="cancel" type="button" id="promo-cancel">Cancel</button>
        <button class="btn blue" id="promo-save" type="button">Save promo</button>
      </div>
      <p class="muted" style="margin:.25rem 0 0;">Saving will replace overlapping promos for your listings during this range.</p>
    </form>
  </dialog>

  <!-- pending approvals modal -->
  <dialog class="modal" id="pending-modal" style="max-width:900px;">
    <form method="dialog">
      <h3 style="margin:.25rem 0 0.6rem;">Approve / Deny pending reservations</h3>
      <div id="pending-table-wrap" style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:8px;">
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead style="position:sticky; top:0; background:#fafafa;">
            <tr>
              <th style="text-align:left; padding:.5rem; border-bottom:1px solid #eee;">Listing</th>
              <th style="text-align:left; padding:.5rem; border-bottom:1px solid #eee;">Start</th>
              <th style="text-align:left; padding:.5rem; border-bottom:1px solid #eee;">End</th>
              <th style="text-align:left; padding:.5rem; border-bottom:1px solid #eee;">Renter</th>
              <th style="text-align:left; padding:.5rem; border-bottom:1px solid #eee;">Actions</th>
            </tr>
          </thead>
          <tbody id="pending-tbody"></tbody>
        </table>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.6rem;">
        <button class="btn white" id="pending-close" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <!-- weekly conflict modal -->
  <dialog class="modal" id="weekly-confirm" style="max-width:620px;">
    <form method="dialog">
      <h3 style="margin:.25rem 0 .6rem;">Update weekly hours</h3>
      <p id="weekly-msg" class="muted" style="margin:.2rem 0 .6rem;"></p>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button class="btn white" value="keep">Keep custom date overrides</button>
        <button class="btn red"   value="override">Override & remove overrides on affected dates</button>
      </div>
    </form>
  </dialog>

  <footer><p style="text-align:center">Servicing Location: Anchorage, AK</p><p style="text-align:center">© 2025 Baro</p></footer>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://lxplphqfkdvjtphafcyt.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4cGxwaHFma2R2anRwaGFmY3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDAxOTQsImV4cCI6MjA3NTQxNjE5NH0.cRm0HrVuhEgALHiyOtlMQWMvDcFXFaBZvBOysshpzjU'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const MAX_CHANGE_MONTHS = 15
    const STATUS_APPROVED='approved'
    const STATUS_DECLINED='declined'

    /* date utils */
    const toLocalISO = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
    const parseLocal = (iso) => { const [y,m,day]=iso.split('-').map(Number); return new Date(y,m-1,day) }
    const addDays = (d,n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n)
    const addDaysISO = (iso,n)=> toLocalISO(addDays(parseLocal(iso),n))
    const addMonths = (d,n)=> new Date(d.getFullYear(), d.getMonth()+n, 1)
    const sameDay = (a,b)=> parseLocal(a).getTime() === parseLocal(b).getTime()
    const fmtHuman = (iso)=> parseLocal(iso).toLocaleDateString(undefined,{weekday:'long', month:'short',day:'numeric',year:'numeric'})
    const fmtHumanShort = (iso)=> parseLocal(iso).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})
    const pad2 = (n)=> String(n).padStart(2,'0')
    const timeHuman = (t)=>{ if(!t) return ''; const [H,M]=t.split(':').map(Number); const A=H>=12?'PM':'AM'; const h=((H+11)%12)+1; return `${h}:${pad2(M)} ${A}` }
    const mmdd = (iso)=> toLocalISO(parseLocal(iso)).slice(5)

    const $ = s => document.querySelector(s)

    /* DOM refs */
    const calEl = $('#cal')
    const gridDow = $('#grid-dow'), gridDays = $('#grid-days'), title = $('#title'), bandLayer = $('#band-layer')
    const prevBtn = $('#prev'), nextBtn = $('#next')
    const jumpMonth = $('#jump-month'), jumpYear = $('#jump-year'), jumpToday = $('#jump-today'), toggleFilters = $('#toggle-filters')
    const banner = $('#blk-banner'), managePanel = $('#manage'), filtersRow = $('#filters')
    const agendaTitle = $('#agenda-title'), agendaSub = $('#agenda-sub'), agendaBody = $('#agenda-body')
    const pendingBtn = $('#btn-view-pending'), pendingCountEl = $('#pending-count')
    // sync panel height to match calendar and disable internal scroll behavior
    function syncPanelHeight(){
      try{
        const leftCol = document.querySelector('.left-col')
        if(!managePanel || !calEl || !leftCol) return
        const top = leftCol.getBoundingClientRect().top + window.scrollY
        const bottom = calEl.getBoundingClientRect().bottom + window.scrollY
        const h = Math.max(0, Math.round(bottom - top))
        managePanel.style.position = 'relative'
        managePanel.style.top = ''
        managePanel.style.maxHeight = 'none'
        managePanel.style.overflow = 'visible'
        managePanel.style.height = h + 'px'
      }catch(_){}
    }
    // Range picker
    const rangeFrom = $('#range-from'), rangeTo = $('#range-to'), btnSelectRange = $('#btn-select-range')
    const repeatAnnually = $('#repeat-annually')

    // Hours controls
    const hrsOpen = $('#hrs-open'), hrsClose = $('#hrs-close')
    const chk24h = $('#chk-24h'), chkClosed = $('#chk-closed')
    const btnSetHours = $('#btn-set-hours'), btnRefreshWeekly = $('#btn-refresh-weekly')
    const btnRemoveOverrides = $('#btn-remove-overrides')
    const weeklyConfirm = $('#weekly-confirm'), weeklyMsg = $('#weekly-msg')

    /* filters (with persistence) */
    let filters = { lend:true, rent:true, owner:true, store:true, pending:true }
    try { filters = { ...filters, ...(JSON.parse(localStorage.getItem('baro_cal_filters')||'{}')) } } catch {}
    const saveFilters = () => localStorage.setItem('baro_cal_filters', JSON.stringify(filters))
    const syncFilterButtons = () => document.querySelectorAll('#filters .filter-toggle').forEach(b=>{ const k=b.dataset.key; const on=!!filters[k]; b.dataset.on=on?'true':'false'; b.setAttribute('aria-pressed',on?'true':'false') })
    syncFilterButtons()
    filtersRow.addEventListener('click', (e)=>{ const b=e.target.closest('.filter-toggle'); if(!b)return; const k=b.dataset.key; const on=b.dataset.on==='true'; b.dataset.on=on?'false':'true'; b.setAttribute('aria-pressed',on?'false':'true'); filters[k]=!on; saveFilters(); render(); updateAgenda() })
    toggleFilters.addEventListener('click', ()=>{ const shown=!filtersRow.hasAttribute('hidden');
      if(shown){
        filtersRow.setAttribute('hidden','');
        toggleFilters.setAttribute('aria-expanded','false')
      } else {
        filtersRow.removeAttribute('hidden');
        toggleFilters.setAttribute('aria-expanded','true')
      }
      requestAnimationFrame(syncPanelHeight)
    })
    /* DOW constants */
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']

    /* state */
    let session=null, userId=null, isAdmin=false, isLender=false
    let view = new Date(); view.setDate(1)
    let selection = new Set()
    let myRentals=[], myLending=[], myListings=[]
    let blackouts=[], promotions=[]
    let weeklyHours=null
    let overridesByISO={} // { 'YYYY-MM-DD': {open_time,close_time,is_closed} }
    let ownerNames = new Map(), renterNames = new Map(), ownerPhones = new Map(), renterPhones = new Map()
    let dowSelected = new Set()

    /* auth + profile */
    {
      const s = await supabase.auth.getSession()
      session = s.data.session
      if (!session?.user) managePanel.style.display='none'
      else {
        userId = session.user.id
        const { data: prof } = await supabase.from('profiles').select('is_admin,is_lender').eq('id', userId).single()
        isAdmin = !!prof?.is_admin; isLender = !!prof?.is_lender
        managePanel.style.display = (isAdmin || isLender) ? 'block' : 'none'
      }
    }

    function daysInMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate() }
    function iso(y,m,d){ return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}` }
    function ownedIds(){ return (myListings||[]).map(l=>l.id) }

    /* ===== Time options ===== */
    function makeTimeOptions(sel){
      sel.innerHTML=''
      for(let h=0; h<24; h++){
        for(let m=0; m<60; m+=30){
          const HH=pad2(h), MM=pad2(m)
          const opt=document.createElement('option')
          opt.value=`${HH}:${MM}`; opt.textContent=timeHuman(`${HH}:${MM}`)
          sel.appendChild(opt)
        }
      }
    }
    makeTimeOptions(hrsOpen); makeTimeOptions(hrsClose)

    /* ===== weekly hours helpers ===== */
    function defaultWeekly(){
      const obj={}
      for(let i=0;i<7;i++) obj[i]={open:'09:00', close:'17:00', closed:false}
      return obj
    }
    function weeklyLabel(dow){
      const h=weeklyHours?.[dow]
      if(!h) return '—'
      if(h.closed) return 'Closed'
      if((h.open==='00:00'&&h.close==='23:59')) return '24 hours'
      return `${timeHuman(h.open)} – ${timeHuman(h.close)}`
    }
    function renderDow(){
      gridDow.innerHTML=''
      for(let i=0;i<7;i++){
        const el=document.createElement('div')
        el.className='dow'
        el.setAttribute('role','button')
        el.setAttribute('tabindex','0')
        el.dataset.dow=i
        el.innerHTML = `${DOW[i]}<span class="hrs">${weeklyLabel(i)}</span>`
        if(dowSelected.has(i)) el.setAttribute('aria-selected','true')

        el.addEventListener('click', ()=>{
          const was = el.getAttribute('aria-selected')==='true'
          el.setAttribute('aria-selected', was?'false':'true')
          if(was) dowSelected.delete(i); else dowSelected.add(i)
          syncSelectionToDOW()
          updateAgenda()
          refreshRemoveOverridesButton()
        })

        gridDow.appendChild(el)
      }
    }

    /* ===== Helpers for header→grid sync ===== */
    function datesForVisibleDow(dow){
      const y=view.getFullYear(), m=view.getMonth()
      const total=daysInMonth(view)
      const out=[]
      for(let d=1; d<=total; d++){
        const dd=new Date(y,m,d)
        if(dd.getDay()===dow){
          const dISO=iso(y,m,d)
          if(withinChangeWindow(dISO)) out.push(dISO)
        }
      }
      return out
    }

    function refreshSelectionHighlight(){
      gridDays.querySelectorAll('.day.sel').forEach(el=>el.classList.remove('sel'))
      for(const d of selection){
        const el = gridDays.querySelector(`.day[data-date="${d}"]`)
        if(el) el.classList.add('sel')
      }
    }

    function syncSelectionToDOW(){
      selection.clear()
      for(const i of dowSelected){
        for(const dISO of datesForVisibleDow(i)) selection.add(dISO)
      }
      refreshSelectionHighlight()
    }
    function selectedDOW(){ return Array.from(gridDow.querySelectorAll('.dow[aria-selected="true"]')).map(el=>parseInt(el.dataset.dow,10)) }
    btnRefreshWeekly.addEventListener('click', async ()=>{ await loadWeeklyHours(); renderDow(); })

    async function loadWeeklyHours(){
      try{
        const { data } = await supabase.from('shop_hours_weekly').select('*').eq('owner_id', userId).single()
        if(!data){ weeklyHours=defaultWeekly() }
        else{
          weeklyHours = {
            0:{open:data.sun_open||'09:00', close:data.sun_close||'17:00', closed: !!data.sun_closed},
            1:{open:data.mon_open||'09:00', close:data.mon_close||'17:00', closed: !!data.mon_closed},
            2:{open:data.tue_open||'09:00', close:data.tue_close||'17:00', closed: !!data.tue_closed},
            3:{open:data.wed_open||'09:00', close:data.wed_close||'17:00', closed: !!data.wed_closed},
            4:{open:data.thu_open||'09:00', close:data.thu_close||'17:00', closed: !!data.thu_closed},
            5:{open:data.fri_open||'09:00', close:data.fri_close||'17:00', closed: !!data.fri_closed},
            6:{open:data.sat_open||'10:00', close:data.sat_close||'16:00', closed: !!data.sat_closed},
          }
        }
        renderDow()
      }catch{
        weeklyHours=null
        banner.textContent='Heads-up: shop_hours_weekly not found or RLS denied.'
        banner.style.display='block'
      }
    }

    function hoursForDate(dISO){
      const ov = overridesByISO[dISO]
      if(ov){
        if(ov.is_closed) return {label:'Closed', custom:true, open:null, close:null}
        if((ov.open_time==='00:00' && ov.close_time==='23:59')) return {label:'24 hours', custom:true, open:'00:00', close:'23:59'}
        return {label:`${timeHuman(ov.open_time)} – ${timeHuman(ov.close_time)}`, custom:true, open:ov.open_time, close:ov.close_time}
      }
      const d=parseLocal(dISO).getDay()
      const h=weeklyHours?.[d]
      if(!h) return {label:'—', custom:false}
      if(h.closed) return {label:'Closed', custom:false}
      if((h.open==='00:00'&&h.close==='23:59')) return {label:'24 hours', custom:false, open:'00:00', close:'23:59'}
      return {label:`${timeHuman(h.open)} – ${timeHuman(h.close)}`, custom:false, open:h.open, close:h.close}
    }

    /* ===== Load visible month ===== */
    async function loadMonthData(){
      const y=view.getFullYear(), m=view.getMonth()
      const startISO=iso(y,m,1), endISO=iso(y,m,daysInMonth(view))

      if (!userId) { myRentals=[]; myLending=[]; myListings=[]; blackouts=[]; promotions=[]; return }

      const { data: rent } = await supabase
        .from('reservations')
        .select('id, listing_id, start_date, end_date, start_time, end_time, status, requires_delivery, renter_id, listings!inner(title, owner_id)')
        .eq('renter_id', userId)
        .lte('start_date', endISO).gte('end_date', startISO)

      myRentals = (rent||[])
        .filter(r => !r.status || r.status.toLowerCase() !== 'cancelled')
        .map(r => ({ ...r, start_date_iso:r.start_date?.slice(0,10), end_date_iso:r.end_date?.slice(0,10), requires_delivery: !!r.requires_delivery }))

      const { data: lend } = await supabase
        .from('reservations')
        .select('id, listing_id, start_date, end_date, start_time, end_time, status, requires_delivery, renter_id, listings!inner(title, owner_id)')
        .eq('listings.owner_id', userId)
        .lte('start_date', endISO).gte('end_date', startISO)

      myLending = (lend||[])
        .filter(r => !r.status || r.status.toLowerCase() !== 'cancelled')
        .map(r => ({ ...r, start_date_iso:r.start_date?.slice(0,10), end_date_iso:r.end_date?.slice(0,10), requires_delivery: !!r.requires_delivery }))

      // owner/renter display names/phones (best effort)
      const ownerIds = new Set(myRentals.map(r=>r.listings?.owner_id).filter(Boolean))
      const renterIds = new Set(myLending.map(r=>r.renter_id).filter(Boolean))
      if(ownerIds.size){
        const { data } = await supabase.from('profiles').select('id, display_name, phone').in('id', [...ownerIds])
        for(const p of (data||[])){ ownerNames.set(p.id, p.display_name||p.id); if(p.phone) ownerPhones.set(p.id,p.phone) }
      }
      if(renterIds.size){
        const { data } = await supabase.from('profiles').select('id, display_name, phone').in('id', [...renterIds])
        for(const p of (data||[])){ renterNames.set(p.id, p.display_name||p.id); if(p.phone) renterPhones.set(p.id,p.phone) }
      }

      if (isLender || isAdmin) {
        const { data: listings } = await supabase.from('listings').select('id,title,owner_id').eq('owner_id', userId).order('title')
        myListings = listings || []
      } else myListings=[]

      try{
        const ids=ownedIds()
        if(ids.length){
          const { data: blk } = await supabase
            .from('listing_blackouts_daily')
            .select('listing_id,date,kind')
            .in('listing_id', ids)
            .gte('date', startISO).lte('date', endISO).order('date')
          blackouts = blk || []
        } else blackouts=[]
        banner.style.display='none'
      }catch{
        blackouts=[]
        banner.textContent='Heads-up: listing_blackouts_daily view not found.'
        banner.style.display='block'
      }

      try{
        const ids=ownedIds()
        if(ids.length){
          const { data: promos } = await supabase
            .from('listing_promotions')
            .select('id,listing_id,start_date,end_date,kind,tier1_value,tier2_value')
            .in('listing_id', ids)
            .lte('start_date', endISO).gte('end_date', startISO).order('start_date')
          promotions = promos || []
        } else promotions=[]
      }catch{ promotions=[] }

      // hours
      if(isLender || isAdmin){
        await loadWeeklyHours()
        overridesByISO={}
        try{
          const { data } = await supabase.from('shop_hours_overrides')
            .select('date,open_time,close_time,is_closed').eq('owner_id', userId)
            .gte('date', startISO).lte('date', endISO)
          for(const r of (data||[])) overridesByISO[r.date]=r
        }catch{}
      }else{
        await loadWeeklyHours()
        overridesByISO={}
      }
    }

    /* ===== Nav / view ===== */
    function seedYearSelect(){
      const now = new Date(), y0=now.getFullYear()-2, y1=now.getFullYear()+5
      const f = document.createDocumentFragment()
      for(let y=y0;y<=y1;y++){ const o=document.createElement('option'); o.value=String(y); o.textContent=y; f.appendChild(o) }
      const had = jumpYear.value
      jumpYear.innerHTML=''; jumpYear.appendChild(f)
      if(had) jumpYear.value=had
    }
    function syncJumpControls(){ jumpMonth.value=String(view.getMonth()); jumpYear.value=String(view.getFullYear()) }
    prevBtn.addEventListener('click', ()=>{ view = new Date(view.getFullYear(), view.getMonth()-1, 1); refresh() })
    nextBtn.addEventListener('click', ()=>{ view = new Date(view.getFullYear(), view.getMonth()+1, 1); refresh() })
    jumpMonth.addEventListener('change', ()=>{ view = new Date(parseInt(jumpYear.value,10), parseInt(jumpMonth.value,10), 1); refresh() })
    jumpYear.addEventListener('change', ()=>{ view = new Date(parseInt(jumpYear.value,10), parseInt(jumpMonth.value,10), 1); refresh() })
    jumpToday.addEventListener('click', ()=>{ const t=new Date(); view=new Date(t.getFullYear(), t.getMonth(), 1); refresh() })

    /* ===== Helpers for overlay runs ===== */
    const weekCount = (firstDow,total)=> Math.ceil((firstDow + total)/7)
    function buildRuns(flagByISO, firstDow, total, y, m, labelForDay){
      const runs=[]
      const weeks=weekCount(firstDow,total)
      for(let r=0;r<weeks;r++){
        let c=0
        while(c<7){
          const di = r*7 + c - firstDow + 1
          const on = di>=1 && di<=total && !!flagByISO[iso(y,m,di)]
          if(!on){ c++; continue }
          let startCol=c+1
          const dISOs=[]
          while(c<7){
            const di2 = r*7 + c - firstDow + 1
            const on2 = di2>=1 && di2<=total && !!flagByISO[iso(y,m,di2)]
            if(!on2) break
            dISOs.push(iso(y,m,di2))
            c++
          }
          const len = dISOs.length
          const midISO = dISOs[Math.floor((len-1)/2)]
          runs.push({ row:r+1, col:startCol, span:len, labelHTML: labelForDay?labelForDay(midISO):'' })
        }
      }
      return runs
    }

    function expandRange(a,b){ const out=[]; for(let d=parseLocal(a); d<=parseLocal(b); d=addDays(d,1)) out.push(toLocalISO(d)); return out }

    /* ===== Build grid ===== */
    function render(){
      const y=view.getFullYear(), m=view.getMonth()
      title.textContent = `${view.toLocaleString(undefined,{month:'long'})} ${y}`
      seedYearSelect()
      syncJumpControls()
      renderDow()
      gridDays.innerHTML=''

      const firstDow=new Date(y,m,1).getDay()
      const total = daysInMonth(view)
      for(let i=0;i<firstDow;i++){ const pad=document.createElement('div'); pad.className='day past'; gridDays.appendChild(pad) }

      // Flags for overlay
      const ownerByISO={}, storeByISO={}
      for(const b of blackouts){ if(b.kind==='owner_unavailable') ownerByISO[b.date]=true; if(b.kind==='store_blocked') storeByISO[b.date]=true }

      // Promotions day flags
      const promoByISO={}, promoLabelByISO={}
      for(const p of promotions){
        const ps=parseLocal(p.start_date.slice(0,10)), pe=parseLocal(p.end_date.slice(0,10))
        for(let d=1; d<=total; d++){
          const dISO=iso(y,m,d), dd=parseLocal(dISO)
          if(dd>=ps && dd<=pe){
            promoByISO[dISO]=true
            if(!promoLabelByISO[dISO]){
              const t1 = p.tier1_value!=null ? p.tier1_value : ''
              promoLabelByISO[dISO] = p.kind==='percent' ? (t1?`${t1}% off`:'Promotion') : (t1?`$${t1} off`:'Promotion')
            }
          }
        }
      }

      // Reservation flags
      const lendConfBy={}, rentConfBy={}
      const pendStartL={}, pendEndL={}, pendStartR={}, pendEndR={}

      // Collect per-day metadata for pending bars (icons + total count)
      const pMeta = { startL:{}, endL:{}, startR:{}, endR:{} }
      function bump(map, dISO, isDelivery){
        const slot = map[dISO] || (map[dISO] = { home:false, truck:false, count:0 })
        slot.count++
        if (isDelivery) slot.truck = true
        else slot.home = true
      }

      // Lender side
      for (const r of myLending){
        const s = (r.status||'').toLowerCase()
        if (s === 'pending'){
          if (r.start_date_iso){
            pendStartL[r.start_date_iso] = (pendStartL[r.start_date_iso]||0) + 1
            bump(pMeta.startL, r.start_date_iso, !!r.requires_delivery)
          }
          if (r.end_date_iso){
            pendEndL[r.end_date_iso] = (pendEndL[r.end_date_iso]||0) + 1
            bump(pMeta.endL, r.end_date_iso, !!r.requires_delivery)
          }
        } else {
          for (const d of expandRange(r.start_date_iso, r.end_date_iso)) lendConfBy[d] = true
        }
      }

      // Renter side
      for (const r of myRentals){
        const s = (r.status||'').toLowerCase()
        if (s === 'pending'){
          if (r.start_date_iso){
            pendStartR[r.start_date_iso] = (pendStartR[r.start_date_iso]||0) + 1
            bump(pMeta.startR, r.start_date_iso, !!r.requires_delivery)
          }
          if (r.end_date_iso){
            pendEndR[r.end_date_iso] = (pendEndR[r.end_date_iso]||0) + 1
            bump(pMeta.endR, r.end_date_iso, !!r.requires_delivery)
          }
        } else {
          for (const d of expandRange(r.start_date_iso, r.end_date_iso)) rentConfBy[d] = true
        }
      }

      const today=new Date(); today.setHours(0,0,0,0); const todayISO=toLocalISO(today)
      for(let day=1; day<=total; day++){
        const dISO=iso(y,m,day)
        const cell=document.createElement('div'); cell.className='day'; cell.dataset.date=dISO
        const thisDay=new Date(y,m,day); thisDay.setHours(0,0,0,0)
        if(thisDay < today) cell.classList.add('past')
        if(dISO===todayISO) cell.classList.add('today')
        if(selection.has(dISO)) cell.classList.add('sel')

        const dateEl=document.createElement('div'); dateEl.className='date'; dateEl.textContent=day
        cell.appendChild(dateEl)

        if(overridesByISO[dISO]){ const ico=document.createElement('div'); ico.className='clock-ico'; ico.textContent='🕒'; cell.appendChild(ico) }

        gridDays.appendChild(cell)
      }

      /* ===== overlay layer ===== */
      bandLayer.innerHTML=''
      const weeks = Math.ceil((firstDow + total)/7)
      const dowH = gridDow.offsetHeight || 0
      const dayH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-h')) || 170
      bandLayer.style.top = dowH + 'px'
      bandLayer.style.gridTemplateRows = `repeat(${weeks}, ${dayH}px)`

      // prevent duplicate bands in the same lane/day
      const _addedBandKeys = new Set();

      function addBands(runs, klass){
        for (const r of runs){
          const key = `${klass}|${r.row}|${r.col}|${r.span}|${r.labelHTML||''}`;
          if (_addedBandKeys.has(key)) continue;
          _addedBandKeys.add(key);

          const el = document.createElement('div');
          el.className = `band ${klass}`;
          el.style.gridRow = String(r.row);
          el.style.gridColumn = `${r.col} / span ${r.span}`;
          el.dataset.col = String(r.col);
          el.dataset.endcol = String(r.col + r.span - 1);

          const pill = document.createElement('div');
          pill.className = 'pill';
          pill.innerHTML = r.labelHTML || '';
          el.appendChild(pill);

          bandLayer.appendChild(el);
        }
      }

      // Draw single-day pending START/END bars, one pill per role
      function addPendingStartEndBars(firstDow, total, y, m){
        if(!filters.pending) return;

        const cellFor = (d)=> {
          const offset = firstDow + (d - 1);
          return { row: Math.floor(offset/7)+1, col: (offset%7)+1 };
        };

        const place = (row, col, klass, roleClass, label, stacked) => {
          const el = document.createElement('div');
          el.className = `band ${klass} ${roleClass}`.trim();
          el.style.gridRow = String(row);
          el.style.gridColumn = `${col} / span 1`;
          el.dataset.col = String(col);
          el.dataset.endcol = String(col);
          if(stacked) el.setAttribute('data-stack','1');
          const pill = document.createElement('div');
          pill.className = 'pill';
          pill.textContent = label;
          el.appendChild(pill);
          bandLayer.appendChild(el);
        };

        const mkLabel = (kind, hasHome, hasTruck, count) => {
          const icons = (hasHome ? '🏠' : '') + (hasTruck ? '🚚' : '');
          return `${kind} ${icons}x${count}`.replace(/\s+/g, ' ').trim();
        };

        for(let d=1; d<=total; d++){
          const dISO = iso(y,m,d);
          const { row, col } = cellFor(d);

          const lStartCnt = pendStartL[dISO]||0;
          const rStartCnt = pendStartR[dISO]||0;

          let stacked = false;
          if(filters.lend && lStartCnt){
            const hasHome  = !!pMeta.startL[dISO]?.home;
            const hasTruck = !!pMeta.startL[dISO]?.truck;
            place(row, col, 'pstart', 'roleL', mkLabel('PENDING START', hasHome, hasTruck, lStartCnt), false);
            stacked = true;
          }
          if(filters.rent && rStartCnt){
            const hasHome  = !!pMeta.startR[dISO]?.home;
            const hasTruck = !!pMeta.startR[dISO]?.truck;
            place(row, col, 'pstart', 'roleR', mkLabel('PENDING START', hasHome, hasTruck, rStartCnt), stacked);
          }

          const lEndCnt = pendEndL[dISO]||0;
          const rEndCnt = pendEndR[dISO]||0;

          stacked = false;
          if(filters.lend && lEndCnt){
            const hasHome  = !!pMeta.endL[dISO]?.home;
            const hasTruck = !!pMeta.endL[dISO]?.truck;
            place(row, col, 'pendend', 'roleL', mkLabel('PENDING END', hasHome, hasTruck, lEndCnt), false);
            stacked = true;
          }
          if(filters.rent && rEndCnt){
            const hasHome  = !!pMeta.endR[dISO]?.home;
            const hasTruck = !!pMeta.endR[dISO]?.truck;
            place(row, col, 'pendend', 'roleR', mkLabel('PENDING END', hasHome, hasTruck, rEndCnt), stacked);
          }
        }
      }

      // Lanes in strict vertical order after pending
      addPendingStartEndBars(firstDow, total, y, m);
      addBands(buildRuns(promoByISO, firstDow, total, y, m, dISO => (promoLabelByISO[dISO] || 'Promotion')),'promo');
      if(filters.lend) addBands(buildRuns(lendConfBy, firstDow, total, y, m, ()=> 'Confirmed Lender'),'confL');
      if(filters.rent) addBands(buildRuns(rentConfBy, firstDow, total, y, m, ()=> 'Confirmed Renter'),'confR');
      if(filters.owner) addBands(buildRuns(ownerByISO, firstDow, total, y, m, ()=> 'Owner unavailable'),'owner');
      if(filters.store) addBands(buildRuns(storeByISO, firstDow, total, y, m, ()=> 'Store blocked'),'store');
      syncSelectionToDOW()

      updateAgenda()
      updatePendingCount()
      refreshRemoveOverridesButton()
      requestAnimationFrame(syncPanelHeight)
    }

    /* selection */
    gridDays.addEventListener('click', (e)=>{
      const cell = e.target.closest('.day'); if(!cell) return
      const d = cell.dataset.date; if(!d) return

      // switching to explicit-date selection cancels header (DOW) mode
      if(dowSelected.size){
        dowSelected.clear()
        gridDow.querySelectorAll('.dow[aria-selected="true"]').forEach(el=>el.setAttribute('aria-selected','false'))
      }

      if(isLender || isAdmin){
        if(selection.has(d)) { selection.delete(d); cell.classList.remove('sel') }
        else { selection.add(d); cell.classList.add('sel') }
      }else{
        selection.clear(); gridDays.querySelectorAll('.day.sel').forEach(el=>el.classList.remove('sel'))
        selection.add(d); cell.classList.add('sel')
      }
      updateAgenda(); refreshRemoveOverridesButton()
    })
    $('#btn-clear').addEventListener('click', ()=>{ selection.clear(); gridDays.querySelectorAll('.day.sel').forEach(el=>el.classList.remove('sel')); updateAgenda(); refreshRemoveOverridesButton() })

    /* range picker → select dates */
    btnSelectRange.addEventListener('click', ()=>{
      const a=rangeFrom.value, b=rangeTo.value
      if(!a || !b) return alert('Pick both From and To dates.')
      const A=parseLocal(a), B=parseLocal(b)
      if(B < A) return alert('End date must be after start date.')
      const dates=expandRange(a,b)
      const tooFar = dates.some(d=>!withinChangeWindow(d))
      if(tooFar) return alert(`Selections are limited to ${MAX_CHANGE_MONTHS} months ahead.`)
      selection.clear()
      for(const d of dates) selection.add(d)
      view = new Date(A.getFullYear(), A.getMonth(), 1)
      refresh()
    })

    /* agenda */
    function isConsecutive(sortedISO){ for(let i=1;i<sortedISO.length;i++){ const prev=parseLocal(sortedISO[i-1]); const cur=parseLocal(sortedISO[i]); if((cur-prev)/(1000*60*60*24)!==1)return false } return true }
    function datesForPeekWeek(){ const t=new Date(); t.setHours(0,0,0,0); const a=[]; for(let i=0;i<7;i++) a.push(toLocalISO(addDays(t,i))); return a }
    function updateAgenda(){
      let selected = Array.from(selection).sort()
      let dates, heading, subline

      if (!selected.length){ dates=datesForPeekWeek(); heading='A peek at the week'; subline=`${fmtHumanShort(dates[0])} → ${fmtHumanShort(dates[dates.length-1])}` }
      else if (selected.length===1){ dates=selected; heading=`Now viewing ${fmtHuman(selected[0])}`; subline='' }
      else { if(isConsecutive(selected)){ dates=expandRange(selected[0], selected[selected.length-1]); heading=`Now viewing ${fmtHumanShort(selected[0])} → ${fmtHumanShort(selected[selected.length-1])}`; subline='' } else { dates=selected; heading='Multiple non-consecutive dates selected'; subline=`Dates: ${selected.map(fmtHumanShort).join(', ')}` } }

      agendaTitle.textContent=heading
      agendaSub.textContent=subline
      agendaBody.innerHTML=''

      const addSection = (html) => { const h=document.createElement('div'); h.className='agenda-section'; h.innerHTML=html; agendaBody.appendChild(h) }
      const addItem = (html) => { const d=document.createElement('div'); d.className='agenda-item'; d.innerHTML=html; agendaBody.appendChild(d) }

      for(const dISO of dates){
        const lenderStart = myLending.filter(r => (r.status||'').toLowerCase()==='pending' && sameDay(r.start_date_iso,dISO))
        const lenderEnd   = myLending.filter(r => (r.status||'').toLowerCase()==='pending' && sameDay(r.end_date_iso,dISO))
        const confLStart  = myLending.filter(r => (r.status||'').toLowerCase()!=='pending' && sameDay(r.start_date_iso,dISO))
        const confLEnd    = myLending.filter(r => (r.status||'').toLowerCase()!=='pending' && sameDay(r.end_date_iso,dISO))

        const renterStart = myRentals.filter(r => (r.status||'').toLowerCase()==='pending' && sameDay(r.start_date_iso,dISO))
        const renterEnd   = myRentals.filter(r => (r.status||'').toLowerCase()==='pending' && sameDay(r.end_date_iso,dISO))
        const confRStart  = myRentals.filter(r => (r.status||'').toLowerCase()!=='pending' && sameDay(r.start_date_iso,dISO))
        const confREnd    = myRentals.filter(r => (r.status||'').toLowerCase()!=='pending' && sameDay(r.end_date_iso,dISO))

        const showCustom  = !!overridesByISO[dISO]

        if(!(lenderStart.length||lenderEnd.length||confLStart.length||confLEnd.length||renterStart.length||renterEnd.length||confRStart.length||confREnd.length||showCustom)) continue

        const dateText = parseLocal(dISO).toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'})
        let headerHtml = dateText
        if(showCustom){
          const h = hoursForDate(dISO)
          let range
          if(h.open && h.close){
            const tight = s => s.replace(/\s+/g,'')
            range = `${tight(timeHuman(h.open))}-${tight(timeHuman(h.close))}`
          }else{
            range = h.label
          }
          headerHtml += ` <span class="custom-hours">🕒 <u>Custom Hours: ${range}</u> 🕒</span>`
        }
        addSection(headerHtml)

        for(const r of lenderStart.concat(lenderEnd)){
          addItem(`
            <div class="warn">PENDING RESERVATION APPROVAL</div>
            <div><b>${r.listings?.title || `Listing #${r.listing_id}`}</b> — ${r.start_time?timeHuman(r.start_time):''}${r.end_time?` → ${timeHuman(r.end_time)}`:''}</div>
            <div>Renter: ${renterNames.get(r.renter_id)||r.renter_id}${renterPhones.get(r.renter_id)?` • ${renterPhones.get(r.renter_id)}`:''}</div>
            <div style="margin-top:.35rem; display:flex; gap:.4rem;">
              <button class="btn green" data-open="approve" data-id="${r.id}" style="padding:.3rem .5rem;">Approve</button>
              <button class="btn red" data-open="deny" data-id="${r.id}" style="padding:.3rem .5rem;">Deny</button>
            </div>
          `)
        }

        for(const r of confLStart.concat(confLEnd)){
          addItem(`<div><b>Your listing</b> • ${r.listings?.title || `Listing #${r.listing_id}`} • ${r.start_time?timeHuman(r.start_time):''}${r.end_time?` → ${timeHuman(r.end_time)}`:''}</div>`)
        }

        for(const r of renterStart.concat(renterEnd)){
          const ownerNm = ownerNames.get(r.listings?.owner_id)||r.listings?.owner_id||''
          addItem(`
            <div class="warn">PENDING RENTAL RESERVATION</div>
            <div><b>${r.listings?.title || `Listing #${r.listing_id}`}</b> — ${r.start_time?timeHuman(r.start_time):''}${r.end_time?` → ${timeHuman(r.end_time)}`:''}</div>
            <div>Owner: ${ownerNm}${ownerPhones.get(r.listings?.owner_id)?` • ${ownerPhones.get(r.listings?.owner_id)}`:''}</div>
            <div>${r.requires_delivery ? 'Delivery requested' : 'Pickup at home location'}</div>
          `)
        }

        for(const r of confRStart.concat(confREnd)){
          addItem(`<div><b>Your rental</b> • ${r.listings?.title || `Listing #${r.listing_id}`} • ${r.start_time?timeHuman(r.start_time):''}${r.end_time?` → ${timeHuman(r.end_time)}`:''} • Delivery: ${r.requires_delivery?'Yes':'No'}</div>`)
        }
      }

      agendaBody.addEventListener('click', async (e)=>{
        const b=e.target.closest('button'); if(!b) return
        const id=b.dataset.id, act=b.dataset.open
        if(!id || !act) return
        try{
          const newStatus = act==='approve' ? STATUS_APPROVED : STATUS_DECLINED
          const { error } = await supabase.from('reservations').update({ status:newStatus }).eq('id', id)
          if(error) throw error
          await loadMonthData(); render()
        }catch(err){ alert('Could not update reservation: '+(err?.message||err)) }
      }, { once:true })
    }

    /* pending quick action */
    function updatePendingCount(){
      const count = (myLending||[]).filter(r => (r.status||'').toLowerCase()==='pending').length
      pendingCountEl.textContent = count
    }
    const pendingModal = $('#pending-modal')
    const pendingTbody = $('#pending-tbody')
    function openPendingModal(){
      pendingTbody.innerHTML=''
      const pending = (myLending||[]).filter(r => (r.status||'').toLowerCase()==='pending')
      if(!pending.length){
        const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.style.padding='.75rem'; td.textContent='No pending reservations found in this range.'; tr.appendChild(td); pendingTbody.appendChild(tr)
      }else{
        for(const r of pending){
          const tr=document.createElement('tr')
          tr.innerHTML = `
            <td style="padding:.5rem; border-bottom:1px solid #eee;">${r.listings?.title || `Listing #${r.listing_id}`}</td>
            <td style="padding:.5rem; border-bottom:1px solid #eee;">${fmtHumanShort(r.start_date_iso)}${r.start_time?` • ${timeHuman(r.start_time)}`:''}</td>
            <td style="padding:.5rem; border-bottom:1px solid #eee;">${fmtHumanShort(r.end_date_iso)}${r.end_time?` • ${timeHuman(r.end_time)}`:''}</td>
            <td style="padding:.5rem; border-bottom:1px solid #eee;">${r.renter_id || ''}</td>
            <td style="padding:.5rem; border-bottom:1px solid #eee;">
              <button data-act="approve" data-id="${r.id}" class="btn green" style="padding:.35rem .5rem;">Approve</button>
              <button data-act="deny" data-id="${r.id}" class="btn red" style="padding:.35rem .5rem;">Deny</button>
            </td>`
          pendingTbody.appendChild(tr)
        }
      }
      pendingModal.showModal()
    }
    pendingBtn.addEventListener('click', openPendingModal)
    pendingTbody.addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return
      const id=b.dataset.id, act=b.dataset.act
      try{
        const newStatus = act==='approve' ? STATUS_APPROVED : STATUS_DECLINED
        const { error } = await supabase.from('reservations').update({ status:newStatus }).eq('id', id)
        if(error) throw error
        await loadMonthData(); render()
      }catch(err){ alert('Could not update reservation: '+(err?.message||err)) }
    })
    $('#pending-close').addEventListener('click', ()=>pendingModal.close())

    /* windows and helpers */
    function withinChangeWindow(dISO){
      const today=new Date(); today.setHours(0,0,0,0)
      const limit=addMonths(today, MAX_CHANGE_MONTHS)
      return parseLocal(dISO) <= new Date(limit.getFullYear(), limit.getMonth()+1, 0)
    }

    function guardSelectionWithinWindow(){
      if(!selection.size) return true
      const bad = Array.from(selection).some(d => !withinChangeWindow(d))
      if(bad){
        alert(`Edits are limited to ${MAX_CHANGE_MONTHS} months ahead.`)
        return false
      }
      return true
    }

    function selectionRanges(){
      const arr = Array.from(selection).sort()
      if(!arr.length) return []
      const out=[]; let start=arr[0], prev=arr[0]
      for(let i=1;i<arr.length;i++){
        const cur=arr[i]
        const diff=(parseLocal(cur)-parseLocal(prev))/(1000*60*60*24)
        if(diff===1){ prev=cur; continue }
        out.push([start,prev]); start=cur; prev=cur
      }
      out.push([start,prev])
      return out
    }

    /* Seasonal helper (repeat annually) */
    async function applySeasonalRule(kind){
      const ranges = selectionRanges()
      if(ranges.length!==1) return alert('Select one continuous range for seasonal repeat.')
      const [ss,se] = ranges[0]
      await supabase.from('shop_seasonal_rules').insert({
        owner_id:userId,
        kind,
        start_mmdd:mmdd(ss),
        end_mmdd:mmdd(se)
      })
      await supabase.rpc('baro_apply_seasonal_rules', { p_owner:userId, p_months_ahead: MAX_CHANGE_MONTHS })
    }

    function refreshRemoveOverridesButton(){
      const anySelectedHasOverride = Array.from(selection).some(d => overridesByISO[d])
      btnRemoveOverrides.classList.toggle('hidden', !anySelectedHasOverride)
    }

    function normalizeHourInputs(){
      if(chkClosed.checked){
        chk24h.checked = false
      }
      if(chk24h.checked){
        chkClosed.checked = false
        hrsOpen.value='00:00'
        hrsClose.value='23:59'
      }
    }
    chk24h.addEventListener('change', normalizeHourInputs)
    chkClosed.addEventListener('change', normalizeHourInputs)

    btnSetHours.addEventListener('click', async ()=>{
      if(!(isLender||isAdmin)) return alert('Only lenders can set hours.')
      const dows = selectedDOW()
      const hasDateSelection = selection.size>0
      if((dows.length>0) && hasDateSelection){
        alert('Choose either weekdays for weekly hours or dates for custom hours, not both.')
        return
      }
      let open=hrsOpen.value, close=hrsClose.value
      let closed = chkClosed.checked
      if(chk24h.checked){ open='00:00'; close='23:59' }

      if(dows.length){
        const affected = await countFutureOverridesForDOW(dows)
        weeklyMsg.textContent = affected
          ? `You’re updating weekly hours for ${dows.map(d=>DOW[d]).join(', ')}. There are ${affected} future date overrides on these weekdays. Keep them, or remove them so weekly hours fully apply.`
          : `You’re updating weekly hours for ${dows.map(d=>DOW[d]).join(', ')}.`
        weeklyConfirm.showModal()
        const decision = await new Promise(res=>{ weeklyConfirm.addEventListener('close', ()=>res(weeklyConfirm.returnValue), { once:true }) })
        try{
          let row
          try{
            const { data } = await supabase.from('shop_hours_weekly').select('*').eq('owner_id', userId).single()
            row = data || { owner_id:userId }
          }catch{ row = { owner_id:userId } }
          const map = [
            ['sun_open','sun_close','sun_closed'],
            ['mon_open','mon_close','mon_closed'],
            ['tue_open','tue_close','tue_closed'],
            ['wed_open','wed_close','wed_closed'],
            ['thu_open','thu_close','thu_closed'],
            ['fri_open','fri_close','fri_closed'],
            ['sat_open','sat_close','sat_closed'],
          ]
          for(const d of dows){
            row[map[d][0]] = open
            row[map[d][1]] = close
            row[map[d][2]] = !!closed
          }
          const { error } = await supabase.from('shop_hours_weekly').upsert(row, { onConflict:'owner_id' })
          if(error) throw error

          if(decision==='override' && affected>0){
            const todayISO=toLocalISO(new Date())
            const { data: allov } = await supabase.from('shop_hours_overrides')
              .select('date').eq('owner_id', userId).gte('date', todayISO)
            const toDelete = (allov||[]).filter(r => dows.includes(parseLocal(r.date).getDay())).map(r=>r.date)
            if(toDelete.length){
              await supabase.from('shop_hours_overrides').delete().eq('owner_id', userId).in('date', toDelete)
            }
          }

          alert('Weekly hours saved.')
          await loadMonthData(); render()
        }catch(e){
          alert('Could not save weekly hours. Ensure table shop_hours_weekly exists and RLS allows updates.')
        }
        return
      }

      if(hasDateSelection){
        try{
          const rows=[]
          for(const d of Array.from(selection).sort()){
            rows.push({ owner_id:userId, date:d, open_time:open, close_time:close, is_closed: !!closed })
          }
          const { error } = await supabase.from('shop_hours_overrides').upsert(rows, { onConflict:'owner_id,date' })
          if(error) throw error
          alert('Custom hours saved for selected dates.')
          selection.clear(); await loadMonthData(); render()
        }catch(e){ alert('Could not save custom hours. Ensure table shop_hours_overrides exists and RLS allows updates.') }
        return
      }

      alert('Pick weekdays (click column headers) or select date cells first.')
    })

    async function countFutureOverridesForDOW(dows){
      try{
        const todayISO = toLocalISO(new Date())
        const { data } = await supabase.from('shop_hours_overrides')
          .select('date').eq('owner_id', userId).gte('date', todayISO)
        let cnt=0
        for(const r of (data||[])){ const dw=parseLocal(r.date).getDay(); if(dows.includes(dw)) cnt++ }
        return cnt
      }catch{ return 0 }
    }

    btnRemoveOverrides.addEventListener('click', async ()=>{
      if(!(isLender||isAdmin)) return alert('Only lenders can set hours.')
      if(!selection.size) return alert('Select one or more dates.')
      try{
        const dates=Array.from(selection).sort()
        await supabase.from('shop_hours_overrides').delete().eq('owner_id', userId).in('date', dates)
        alert('Removed custom hours for the selected dates.')
        selection.clear(); await loadMonthData(); render()
      }catch(e){ alert('Could not remove overrides: '+(e?.message||e)) }
    })

    /* blackout ops */
    async function upsertBlackout(kind){
      try{
        // Allow either explicit cell selection or weekday-header selection
        const dows = selectedDOW()
        const hasDOW = dows.length > 0
        const hasCells = selection.size > 0

        if(!hasDOW && !hasCells){
          alert('Select dates or click a weekday header.')
          return
        }

        const ids = ownedIds()
        if(!ids.length){
          alert('No listings available.')
          return
        }

        // Materialize dates for DOW mode across the next 15 months; otherwise use the selected cells
        function generateForwardDOWDates(dowsArr){
          const set = new Set(dowsArr)
          const today = new Date(); today.setHours(0,0,0,0)
          const limitMonthStart = addMonths(today, MAX_CHANGE_MONTHS)
          const limitEnd = new Date(limitMonthStart.getFullYear(), limitMonthStart.getMonth() + 1, 0)
          const out = []
          for(let d = new Date(today); d <= limitEnd; d = addDays(d, 1)){
            if(set.has(d.getDay())) out.push(toLocalISO(d))
          }
          return out
        }

        const selectedDates = hasDOW
          ? generateForwardDOWDates(dows)
          : Array.from(selection).sort()

        if(!selectedDates.length){
          alert('No dates inside the 15-month window.')
          return
        }

        const { data: existing } = await supabase
          .from('listing_blackouts')
          .select('listing_id,start_date,kind')
          .in('listing_id', ids)
          .in('start_date', selectedDates)
          .eq('kind', kind)

        const existingSet=new Set((existing||[]).map(r=>`${r.listing_id}_${r.start_date}_${r.kind}`))
        const rows=[]
        for(const id of ids){
          for(const d of selectedDates){
            const key=`${id}_${d}_${kind}`
            if(!existingSet.has(key)) rows.push({ listing_id:id, start_date:d, end_date:d, kind })
          }
        }

        if(!rows.length){
          alert('One or more selected dates are already marked for that blackout type. Nothing to add.')
        }else{
          const { error } = await supabase.from('listing_blackouts')
            .upsert(rows, { onConflict:'listing_id,start_date,end_date,kind' })
          if(error) throw error
          alert('Blackout(s) saved. Existing dates were ignored.')
        }
      }catch(e){
        console.error(e)
        alert('Could not save blackout: '+(e?.message||e))
      }finally{
        selection.clear()
        await loadMonthData(); render()
      }
    }

    async function removeBlackout(kind){
      try{
        const dows = selectedDOW()
        const hasDOW = dows.length > 0
        const hasCells = selection.size > 0

        if(!hasDOW && !hasCells){
          alert('Select dates or click a weekday header.')
          return
        }

        const ids = ownedIds()
        if(!ids.length){
          alert('No listings available.')
          return
        }

        function generateForwardDOWDates(dowsArr){
          const set = new Set(dowsArr)
          const today = new Date(); today.setHours(0,0,0,0)
          const limitMonthStart = addMonths(today, MAX_CHANGE_MONTHS)
          const limitEnd = new Date(limitMonthStart.getFullYear(), limitMonthStart.getMonth() + 1, 0)
          const out = []
          for(let d = new Date(today); d <= limitEnd; d = addDays(d, 1)){
            if(set.has(d.getDay())) out.push(toLocalISO(d))
          }
          return out
        }

        const dates = hasDOW
          ? generateForwardDOWDates(dows)
          : Array.from(selection).sort()

        if(!dates.length){
          alert('No dates inside the 15-month window.')
          return
        }

        await supabase.from('listing_blackouts').delete().in('listing_id', ids).in('start_date', dates).eq('kind', kind)
        selection.clear(); await loadMonthData(); render(); alert('Removed blackout entries for the selected dates.')
      }catch(e){
        console.error(e)
        alert('Could not remove entries: '+(e?.message||e))
      }
    }

    $('#btn-unavail-add').addEventListener('click',  ()=>upsertBlackout('owner_unavailable'))
    $('#btn-unavail-remove').addEventListener('click',()=>removeBlackout('owner_unavailable'))
    $('#btn-block-add').addEventListener('click',     ()=>upsertBlackout('store_blocked'))
    $('#btn-block-remove').addEventListener('click',  ()=>removeBlackout('store_blocked'))

    /* promos */
    const promoModal=$('#promo-modal')
    $('#btn-promo-add').addEventListener('click', ()=>{
      const y=view.getFullYear(), m=view.getMonth()
      const dates=Array.from(selection).sort()
      const start=dates[0]||iso(y,m,1)
      const end=dates[dates.length-1]||iso(y,m,daysInMonth(view))
      $('#promo-start').value=start; $('#promo-end').value=end
      promoModal.showModal()
    })
    $('#promo-cancel').addEventListener('click', ()=>promoModal.close())
    $('#promo-save').addEventListener('click', async ()=>{
      try{
        const type=$('#promo-type').value, start=$('#promo-start').value, end=$('#promo-end').value
        const today=new Date(); today.setHours(0,0,0,0)
        const limEnd=new Date(addMonths(today, MAX_CHANGE_MONTHS).getFullYear(), addMonths(today, MAX_CHANGE_MONTHS).getMonth()+1, 0)
        if(parseLocal(end)>limEnd) return alert(`Promotions cannot be saved beyond ${MAX_CHANGE_MONTHS} months ahead.`)
        const t1v=parseFloat($('#t1-value').value)||null, t1min=parseInt($('#t1-min').value,10)||null, t1max=parseInt($('#t1-max').value,10)||null
        const t2v=parseFloat($('#t2-value').value)||null, t2min=parseInt($('#t2-min').value,10)||null, t2max=parseInt($('#t2-max').value,10)||null
        if(!start||!end) return alert('Choose a promo date range.')
        const ids=ownedIds(); if(!ids.length) return alert('No listings available.')
        await supabase.from('listing_promotions').delete().in('listing_id', ids).lte('start_date', end).gte('end_date', start)
        const rows=ids.map(id=>({ listing_id:id, kind:type, tier1_value:t1v, tier1_min_days:t1min, tier1_max_days:t1max, tier2_value:t2v, tier2_min_days:t2min, tier2_max_days:t2max, start_date:start, end_date:end }))
        const { error } = await supabase.from('listing_promotions').insert(rows)
        if(error) throw error
        promoModal.close(); alert('Promotional pricing saved.'); await loadMonthData(); render()
      }catch(e){ alert('Could not save promo. Ensure the listing_promotions table exists with policies.'); }
    })

    async function trimPromotionsInRanges(){
      try{
        const dows = selectedDOW()
        const hasDOW = dows.length > 0
        const hasCells = selection.size > 0

        if(!hasDOW && !hasCells){
          return alert('Select dates or click a weekday header to trim/remove promotions.')
        }

        const ids = ownedIds()
        if(!ids.length){
          return alert('No listings available.')
        }

        function generateForwardDOWDates(dowsArr){
          const set = new Set(dowsArr)
          const today = new Date(); today.setHours(0,0,0,0)
          const limitMonthStart = addMonths(today, MAX_CHANGE_MONTHS)
          const limitEnd = new Date(limitMonthStart.getFullYear(), limitMonthStart.getMonth() + 1, 0)
          const out = []
          for(let d = new Date(today); d <= limitEnd; d = addDays(d, 1)){
            if(set.has(d.getDay())) out.push(toLocalISO(d))
          }
          return out
        }

        function compressToRanges(datesArr){
          if(!datesArr.length) return []
          const sorted = Array.from(new Set(datesArr)).sort()
          const ranges = []
          let start = sorted[0], prev = sorted[0]
          for(let i=1;i<sorted.length;i++){
            const cur = sorted[i]
            const prevDate = parseLocal(prev)
            const curDate  = parseLocal(cur)
            const diff = (curDate - prevDate) / (1000*60*60*24)
            if(diff === 1){
              prev = cur
              continue
            }
            ranges.push([start, prev])
            start = cur
            prev  = cur
          }
          ranges.push([start, prev])
          return ranges
        }

        const dateList = hasDOW
          ? generateForwardDOWDates(dows)
          : Array.from(selection).sort()

        if(!dateList.length){
          return alert('No dates inside the 15-month window.')
        }

        const ranges = hasDOW
          ? compressToRanges(dateList)
          : selectionRanges()

        // For each selected range, trim promos that overlap that range
        for(const [ss,se] of ranges){
          const { data: promos } = await supabase
            .from('listing_promotions')
            .select('id,listing_id,start_date,end_date,kind,tier1_value,tier1_min_days,tier1_max_days,tier2_value,tier2_min_days,tier2_max_days')
            .in('listing_id', ids)
            .lte('start_date', se)
            .gte('end_date', ss)

          for(const p of (promos||[])){
            const ps=p.start_date.slice(0,10), pe=p.end_date.slice(0,10)

            // Case 1: selection fully covers promo -> delete
            if(ss<=ps && se>=pe){
              await supabase.from('listing_promotions').delete().eq('id', p.id)
              continue
            }
            // Case 2: selection sits inside promo -> split into left+right
            if(ss>ps && se<pe){
              // shrink current to left half
              await supabase.from('listing_promotions').update({ end_date: addDaysISO(ss,-1) }).eq('id', p.id)
              // insert right half
              await supabase.from('listing_promotions').insert({
                listing_id:p.listing_id, kind:p.kind,
                tier1_value:p.tier1_value, tier1_min_days:p.tier1_min_days, tier1_max_days:p.tier1_max_days,
                tier2_value:p.tier2_value, tier2_min_days:p.tier2_min_days, tier2_max_days:p.tier2_max_days,
                start_date:addDaysISO(se,1), end_date:pe
              })
              continue
            }
            // Case 3: selection trims the beginning of promo
            if(ss<=ps && se<pe && se>=ps){
              await supabase.from('listing_promotions').update({ start_date: addDaysISO(se,1) }).eq('id', p.id)
              continue
            }
            // Case 4: selection trims the end of promo
            if(ss>ps && ss<=pe && se>=pe){
              await supabase.from('listing_promotions').update({ end_date: addDaysISO(ss,-1) }).eq('id', p.id)
              continue
            }
          }
        }

        selection.clear(); await loadMonthData(); render(); alert('Promotions trimmed.')
      }catch(e){
        alert('Could not trim promotions: '+(e?.message||e))
      }
    }
    $('#btn-promo-remove').addEventListener('click', trimPromotionsInRanges)

    async function refresh(){ await loadMonthData(); render() }

    const params=new URLSearchParams(location.search); const focus=params.get('focus')
    if(focus && /^\d{4}-\d{2}-\d{2}$/.test(focus)){ const f=parseLocal(focus); if(!Number.isNaN(f.getTime())) view=new Date(f.getFullYear(), f.getMonth(), 1) }

    await loadWeeklyHours(); renderDow(); await refresh()
    addEventListener('resize', ()=>requestAnimationFrame(syncPanelHeight))
    supabase.auth.onAuthStateChange(async ()=>{ await refresh() })
  </script>

  <script src="script.js" defer></script>
</body>
</html>
