<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BARO • Calendar</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* --- page frame --- */
    main { max-width:1100px; margin:0 auto; padding:1.25rem 1rem 2rem; }

    /* --- two-column shell --- */
    .cal-wrap { display:grid; grid-template-columns: 1fr 320px; gap:1rem; }
    @media (max-width: 900px){ .cal-wrap { grid-template-columns: 1fr; } }

    /* left column containers so header width matches calendar width */
    .left-col { display:grid; gap:.6rem; }

    /* --- calendar header (prev/title/next + jump controls + filters button) --- */
    .cal-header{
      background:#fff; border:1px solid #eee; border-radius:10px;
      padding:.6rem .6rem .6rem; display:grid; gap:.55rem;
    }
    .cal-nav{
      display:grid; grid-template-columns:auto 1fr auto; gap:.5rem; align-items:center;
    }
    .cal-title{ font-weight:800; font-size:1.35rem; text-align:center; }
    .navbtn{
      border:none; background:#000; color:#fff; border-radius:10px; padding:.5rem .8rem; cursor:pointer;
    }

    .jump-controls{
      display:grid; grid-template-columns:1fr 1fr auto auto; gap:.5rem; align-items:center;
    }
    .jump-controls select{
      width:100%; padding:.5rem .6rem; border:1px solid #ddd; border-radius:8px; background:#fff;
    }
    .pill{
      padding:.45rem .7rem; border:1px solid #ddd; border-radius:999px; background:#fff; cursor:pointer;
    }

    /* --- compact filter toggles (collapsible) --- */
    .filters-row{
      background:#fff; border:1px solid #eee; border-radius:10px;
      padding:.5rem; display:grid; grid-template-columns:repeat(4, minmax(120px,1fr)); gap:.5rem;
    }
    .filters-row[hidden]{ display:none; }
    .filter-toggle{
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      gap:.4rem; padding:.45rem .6rem; border-radius:10px;
      border:1px solid #dcdcdc; background:#f7f7f7; color:#222;
      font-weight:700; cursor:pointer; user-select:none;
      box-shadow:0 1px 0 rgba(0,0,0,.04), 0 1px 2px rgba(0,0,0,.06);
      transition:transform .02s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
    }
    .filter-toggle:active{ transform:translateY(1px); }
    .filter-toggle .check{
      width:14px; height:14px; border-radius:3px; border:1px solid #bbb; background:#fff;
      display:inline-grid; place-items:center; font-size:12px; line-height:1;
    }
    .filter-toggle[data-on="true"]{ box-shadow: inset 0 0 0 2px #0002; color:#111; }
    .filter-lend[data-on="true"] { background:#e5fff0; color:#065f46; border-color:#bdebd8; }
    .filter-rent[data-on="true"] { background:#e9f2ff; color:#0b57d0; border-color:#c8dcff; }
    .filter-owner[data-on="true"]{ background:#fff1e6; color:#b36b00; border-color:#ffd8b5; }
    .filter-store[data-on="true"]{ background:#ffe6e6; color:#b00020; border-color:#ffc1c1; }
    .filter-toggle[data-on="true"] .check{ border-color:currentColor; }
    .filter-toggle[data-on="true"] .check::after{ content:"✓"; }

    /* calendar box */
    .cal { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); overflow:hidden; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
    .dow { background:#fafafa; padding:.5rem .4rem; border-bottom:1px solid #eee; font-weight:700; font-size:.9rem; text-align:center; }
    .day {
      height:110px;
      border-right:1px solid #f3f3f3; border-bottom:1px solid #f3f3f3;
      padding:.35rem; position:relative; cursor:pointer; overflow:hidden;
      display:flex; flex-direction:column;
    }
    .day:nth-child(7n) { border-right: none; }
    .date { font-weight:700; font-size:.95rem; }
    .past { background:#e9e9e9; color:#666; }
    .today .date{ outline:2px solid #0b57d0; outline-offset:2px; border-radius:999px; padding:.1rem .35rem; }

    /* summary chips zone under date */
    .chips { margin-top:.2rem; display:flex; flex-direction:column; gap:.2rem; max-height:66px; overflow:hidden; }
    .chip { display:inline-flex; align-items:center; gap:.35rem; font-size:.78rem; border-radius:6px; padding:.15rem .35rem; width:max-content; line-height:1.15; }
    /* rentals as edges only (kept for renter summary) */
    .chip-rent-start { background:#fff; color:#0b57d0; border:2px solid #0b57d0; }
    .chip-rent-end   { background:#0b57d0; color:#fff; }
    /* lender summaries */
    .chip-sum        { background:#fff; border:1px solid #ddd; color:#111; }
    .chip-sum.l-deliver { border-color:#0b57d0; color:#0b57d0; }   /* to deliver */
    .chip-sum.l-handoff { border-color:#087f5b; color:#087f5b; }   /* pickup at owner / handoff */
    .chip-sum.l-rtn-pu  { border-color:#b00020; color:#b00020; }   /* return pickup */
    .chip-sum.l-rtn-due { border-color:#b36b00; color:#b36b00; }   /* return due at owner */
    /* blackouts as bars */
    .blk-lane { position:absolute; left:4px; right:4px; top:22px; height:16px; z-index:1; }
    .blk-strip { position:absolute; left:0; right:0; height:16px; display:flex; align-items:center; justify-content:center; font-size:.72rem; line-height:1; pointer-events:none; }
    .blk-owner { background:#fff1e6; color:#b36b00; }
    .blk-store { background:#ffe6e6; color:#b00020; }
    .run-solo { border-radius:8px; }
    .run-start{ border-radius:8px 0 0 8px; }
    .run-mid  { border-radius:0; }
    .run-end  { border-radius:0 8px 8px 0; }
    .bar-label { pointer-events:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 .3rem; }
    .blk-strip:hover .bar-label, .promo-strip:hover .promo-label { animation: marquee 8s linear infinite; }
    @keyframes marquee { from { transform:translateX(0) } to { transform:translateX(-40%) } }

    /* promo lane at bottom of each cell */
    .promo-lane { position:absolute; left:4px; right:4px; bottom:4px; height:18px; z-index:2; }
    .promo-strip { position:absolute; left:0; right:0; height:18px; background:#f0f5ff; color:#0052cc;
      display:flex; align-items:center; justify-content:center; font-size:.72rem; line-height:1; pointer-events:none; }
    .promo-run-solo { border-radius:8px; }
    .promo-run-start{ border-radius:8px 0 0 8px; }
    .promo-run-mid  { border-radius:0; }
    .promo-run-end  { border-radius:0 8px 8px 0; }
    .promo-label { pointer-events:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 .3rem; }

    .sel { outline:2px solid #0b57d0; outline-offset:-2px; background:#eef6ff; }

    /* side panel */
    .panel { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:1rem; }
    .panel h3{ margin:.2rem 0 .4rem; }
    .vgap { display:grid; gap:.6rem; }
    .btn-full { width:100%; }

    /* paired buttons layout */
    .btn-pair { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }

    /* color variants */
    .btn { background:#000; color:#fff; border:none; cursor:pointer; border-radius:8px; padding:.55rem .6rem; }
    .btn.orange { background:#b36b00; } /* mark unavailable */
    .btn.gold   { background:#ca8a04; } /* mark available */
    .btn.red    { background:#b00020; } /* block all rentals */
    .btn.green  { background:#28a745; } /* remove block */
    .btn.blue   { background:#007bff; } /* add promo */
    .btn.gray   { background:#6b7280; } /* remove promo */
    .btn.white  { background:#fff; color:#111; border:1px solid #ddd; }

    .hint { font-size:.9rem; color:#555; }
    .banner { padding:.5rem .6rem; border-radius:8px; background:#fff7e6; color:#b36b00; border:1px solid #ffd188; margin-bottom:.5rem; }

    /* agenda */
    .agenda { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:1rem; }
    .agenda h4{ margin:.2rem 0 .4rem; }
    .agenda .subtitle{ margin:.1rem 0 .6rem; color:#666; font-size:.92rem; }
    .agenda ul{ margin:0; padding-left:1.1rem; }
    .agenda li{ margin:.2rem 0; }

    /* promo modal */
    dialog.modal{ border:none; border-radius:12px; padding:0; max-width:560px; width:calc(100% - 2rem); }
    .modal > form{ padding:1rem; display:grid; gap:.6rem; }
    .modal .row{ display:grid; grid-template-columns:1fr 1fr; gap:.6rem; }
    .modal .actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.4rem; }
    .muted{ color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <!-- shared header -->
  <div id="header"></div>
  <script>
    (async () => {
      const host = document.getElementById('header');
      try {
        const res = await fetch('./header.html', { cache:'no-store' });
        if (!res.ok) throw new Error('Failed to load header');
        host.innerHTML = await res.text();
        const boot = () => window.initHero && window.initHero();
        if (document.readyState === 'complete') boot();
        else addEventListener('load', boot);
      } catch (err) {
        console.error('Header load failed:', err);
        host.innerHTML = '<p style="color:red;text-align:center;">Header failed to load</p>';
      }
    })();
  </script>

  <main>
    <div class="cal-wrap">
      <!-- LEFT COLUMN: header + filters + calendar + agenda -->
      <div class="left-col">
        <!-- calendar header -->
        <section class="cal-header">
          <div class="cal-nav">
            <button class="navbtn" id="prev" aria-label="Previous month">←</button>
            <div class="cal-title" id="title">Calendar</div>
            <button class="navbtn" id="next" aria-label="Next month">→</button>
          </div>
          <div class="jump-controls">
            <select id="jump-month" aria-label="Jump to month">
              <option value="0">January</option><option value="1">February</option><option value="2">March</option>
              <option value="3">April</option><option value="4">May</option><option value="5">June</option>
              <option value="6">July</option><option value="7">August</option><option value="8">September</option>
              <option value="9">October</option><option value="10">November</option><option value="11">December</option>
            </select>
            <select id="jump-year" aria-label="Jump to year"></select>
            <button class="pill" id="jump-today" type="button" title="Jump to current month">Today</button>
            <button class="pill" id="toggle-filters" type="button" aria-expanded="false" aria-controls="filters">Filters</button>
          </div>
        </section>

        <!-- filter toggles -->
        <div class="filters-row" id="filters" hidden>
          <button type="button" class="filter-toggle filter-lend"  data-key="lend"  data-on="true" aria-pressed="true">
            <span class="check" aria-hidden="true"></span> Lender obligations
          </button>
          <button type="button" class="filter-toggle filter-rent"  data-key="rent"  data-on="true" aria-pressed="true">
            <span class="check" aria-hidden="true"></span> Your rentals
          </button>
          <button type="button" class="filter-toggle filter-owner" data-key="owner" data-on="true" aria-pressed="true">
            <span class="check" aria-hidden="true"></span> Owner unavailable
          </button>
          <button type="button" class="filter-toggle filter-store" data-key="store" data-on="true" aria-pressed="true">
            <span class="check" aria-hidden="true"></span> Store blocked
          </button>
        </div>

        <!-- calendar grid -->
        <section class="cal">
          <div class="cal-grid" id="grid-dow"></div>
          <div class="cal-grid" id="grid-days"></div>
        </section>

        <!-- agenda -->
        <section class="agenda" id="agenda">
          <h4 id="agenda-title">A peek at the week</h4>
          <div id="agenda-sub" class="subtitle"></div>
          <ul id="agenda-list"></ul>
        </section>
      </div>

      <!-- RIGHT COLUMN: shop-wide tools only -->
      <aside class="panel" id="manage">
        <div id="blk-banner" class="banner" style="display:none;"></div>

        <h3>Shop-wide tools</h3>
        <p class="hint">Select dates on the calendar to manage availability, store-wide blocks, and promotions across all your listings.</p>

        <div class="vgap">
          <div>
            <label>Availability</label>
            <div class="btn-pair">
              <button class="btn orange" id="btn-unavail-add"  title="Mark selected dates as owner unavailable (applies to all your listings).">Mark unavailable</button>
              <button class="btn gold"   id="btn-unavail-remove" title="Remove owner-unavailable marks on selected dates.">Mark available</button>
            </div>
          </div>

          <div>
            <label>Store recall</label>
            <div class="btn-pair">
              <button class="btn red"   id="btn-block-add"    title="Block all rentals for selected dates (store_blocked).">Block all rentals</button>
              <button class="btn green" id="btn-block-remove" title="Remove store-wide block for selected dates.">Remove block</button>
            </div>
          </div>

          <div>
            <label>Promotions</label>
            <div class="btn-pair">
              <button class="btn blue" id="btn-promo-add"    title="Add promotional pricing over a date range for all your listings.">Add promotion</button>
              <button class="btn gray" id="btn-promo-remove" title="Trim/remove promotions overlapping selected dates.">Remove promotion</button>
            </div>
          </div>

          <button class="btn white btn-full" id="btn-clear">Cancel selection</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- Promo modal -->
  <dialog class="modal" id="promo-modal">
    <form method="dialog" id="promo-form">
      <h3 style="margin:.25rem 0;">Add promotional pricing</h3>

      <div class="row">
        <div>
          <label>Discount type</label>
          <select id="promo-type">
            <option value="percent">% off</option>
            <option value="flat">$ off per day</option>
          </select>
        </div>
        <div>
          <label>Applies to</label>
          <input value="All owned listings" disabled style="width:100%; padding:.55rem .6rem; border:1px solid #eee; border-radius:8px; background:#fafafa; color:#333;">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Range start</label>
          <input type="date" id="promo-start" required />
        </div>
        <div>
          <label>Range end</label>
          <input type="date" id="promo-end" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tier 1</label>
          <input id="t1-value" type="number" step="0.01" placeholder="10 (percent or dollars)" />
          <div class="muted">Min days <input id="t1-min" type="number" min="1" style="width:5em"> Max <input id="t1-max" type="number" min="1" style="width:5em"></div>
        </div>
        <div>
          <label>Tier 2</label>
          <input id="t2-value" type="number" step="0.01" placeholder="20 (percent or dollars)" />
          <div class="muted">Min days <input id="t2-min" type="number" min="1" style="width:5em"> Max <input id="t2-max" type="number" min="1" style="width:5em"></div>
        </div>
      </div>

      <div class="actions">
        <button value="cancel" type="button" id="promo-cancel">Cancel</button>
        <button class="btn blue" id="promo-save" type="button">Save promo</button>
      </div>
      <p class="muted" style="margin:.25rem 0 0;">Saving will replace overlapping promos for your listings during this range.</p>
    </form>
  </dialog>

  <footer><p style="text-align:center">Servicing Location: Anchorage, AK</p><p style="text-align:center">© 2025 Baro</p></footer>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://lxplphqfkdvjtphafcyt.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4cGxwaHFma2R2anRwaGFmY3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDAxOTQsImV4cCI6MjA3NTQxNjE5NH0.cRm0HrVuhEgALHiyOtlMQWMvDcFXFaBZvBOysshpzjU'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    /* ---------- config ---------- */
    const MAX_CHANGE_MONTHS = 15  // prohibit changes beyond this many months ahead

    /* ---------- small date helpers (LOCAL, not UTC) ---------- */
    const toLocalISO = (d) => {
      const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate()
      return `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`
    }
    const parseLocal = (iso) => {
      const [y,m,d] = iso.split('-').map(Number)
      return new Date(y, m-1, d) // local midnight
    }
    const addDays = (d, n) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+n)
    const addDaysISO = (iso, n) => toLocalISO(addDays(parseLocal(iso), n))
    const addMonths = (d, n) => new Date(d.getFullYear(), d.getMonth()+n, 1)
    const sameDay = (a,b) => parseLocal(a).getTime() === parseLocal(b).getTime()
    const fmtHuman = (isoStr) => {
      const d = parseLocal(isoStr)
      return d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' })
    }
    const pad2 = (n)=> String(n).padStart(2,'0')
    const timeHuman = (t)=> {
      if (!t) return ''
      const [H,M] = t.split(':').map(Number)
      const ampm = H>=12 ? 'PM':'AM'
      const h = ((H+11)%12)+1
      return `${h}:${pad2(M)} ${ampm}`
    }

    const $ = s => document.querySelector(s)
    const gridDow = $('#grid-dow'), gridDays = $('#grid-days'), title = $('#title')
    const prevBtn = $('#prev'), nextBtn = $('#next')
    const jumpMonth = $('#jump-month'), jumpYear = $('#jump-year'), jumpToday = $('#jump-today'), toggleFilters = $('#toggle-filters')
    const banner = $('#blk-banner')
    const managePanel = $('#manage')
    const filtersRow = $('#filters')

    const agendaTitle = $('#agenda-title'), agendaSub = $('#agenda-sub'), agendaList = $('#agenda-list')

    // Filter button state with persistence
    let filters = { lend:true, rent:true, owner:true, store:true }
    try {
      const saved = JSON.parse(localStorage.getItem('baro_cal_filters')||'{}')
      filters = { ...filters, ...saved }
    } catch {}
    const applyFilterButtonsFromState = () => {
      document.querySelectorAll('#filters .filter-toggle').forEach(btn=>{
        const k = btn.dataset.key
        const on = !!filters[k]
        btn.dataset.on = on ? 'true':'false'
        btn.setAttribute('aria-pressed', on ? 'true':'false')
      })
    }
    const persistFilters = () => localStorage.setItem('baro_cal_filters', JSON.stringify(filters))
    applyFilterButtonsFromState()

    // filter container click handler
    filtersRow.addEventListener('click', (e)=>{
      const btn = e.target.closest('.filter-toggle'); if (!btn) return
      const k = btn.dataset.key
      const on = btn.dataset.on === 'true'
      btn.dataset.on = on ? 'false' : 'true'
      btn.setAttribute('aria-pressed', on ? 'false' : 'true')
      filters[k] = !on
      persistFilters()
      render(); updateAgenda()
    })
    toggleFilters.addEventListener('click', ()=>{
      const shown = !filtersRow.hasAttribute('hidden')
      if (shown) { filtersRow.setAttribute('hidden',''); toggleFilters.setAttribute('aria-expanded','false')}
      else { filtersRow.removeAttribute('hidden'); toggleFilters.setAttribute('aria-expanded','true')}
    })

    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
    for (const d of DOW) {
      const el = document.createElement('div'); el.className='dow'; el.textContent=d; gridDow.appendChild(el)
    }

    // deep link: ?listing=<id> will narrow counts + agenda to that listing
    const params = new URLSearchParams(location.search)
    const focusListingParam = params.get('listing')
    const focusListingId = focusListingParam ? Number(focusListingParam) : null

    // state
    let session = null, userId = null, isAdmin = false, isLender = false
    let view = new Date(); view.setDate(1)
    let selection = new Set() // ISO dates
    let myRentals = [], myLending = [], myListings = []
    let blackouts = [] // daily dots { listing_id, date, kind }
    let promotions = [] // promo spans { id, listing_id, start_date, end_date, kind, tiers... }

    // auth + profile
    {
      const s = await supabase.auth.getSession()
      session = s.data.session
      if (!session?.user) {
        managePanel.style.display = 'none'
      } else {
        userId = session.user.id
        const { data: prof } = await supabase.from('profiles').select('is_admin,is_lender').eq('id', userId).single()
        isAdmin = !!prof?.is_admin; isLender = !!prof?.is_lender
        managePanel.style.display = (isAdmin || isLender) ? 'block' : 'none'
      }
    }

    function daysInMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate() }
    function iso(y,m,d){ return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}` }

    function getOwnedListingIds() {
      return (myListings || []).map(l => l.id)
    }

    async function loadMonthData() {
      const y = view.getFullYear(), m = view.getMonth()
      const startISO = iso(y,m,1)
      const endISO   = iso(y,m,daysInMonth(view))

      if (userId) {
        const baseSelect = 'id, listing_id, start_date, end_date, start_time, end_time, status, requires_delivery, listings!inner(title, owner_id)'
        const { data: rent } = await supabase
          .from('reservations')
          .select(baseSelect)
          .eq('renter_id', userId)
          .lte('start_date', endISO).gte('end_date', startISO)

        myRentals = (rent||[])
          .filter(r => !r.status || r.status.toLowerCase() !== 'cancelled')
          .map(r => ({ ...r, start_date_iso: r.start_date?.slice(0,10), end_date_iso: r.end_date?.slice(0,10) }))

        const { data: lend } = await supabase
          .from('reservations')
          .select(baseSelect)
          .eq('listings.owner_id', userId)
          .lte('start_date', endISO).gte('end_date', startISO)

        myLending = (lend||[])
          .filter(r => !r.status || r.status.toLowerCase() !== 'cancelled')
          .map(r => ({ ...r, start_date_iso: r.start_date?.slice(0,10), end_date_iso: r.end_date?.slice(0,10) }))

        // optional focus to one listing
        if (focusListingId) {
          myRentals = myRentals.filter(r => r.listing_id === focusListingId)
          myLending = myLending.filter(r => r.listing_id === focusListingId)
        }

        if (isLender || isAdmin) {
          const { data: listings } = await supabase
            .from('listings').select('id,title,owner_id')
            .eq('owner_id', userId).order('title')
          myListings = listings || []
        } else {
          myListings = []
        }

        try {
          const ids = getOwnedListingIds();
          if (ids.length) {
            const { data: blk, error } = await supabase
              .from('listing_blackouts_daily')
              .select('listing_id,date,kind')
              .in('listing_id', ids)
              .gte('date', startISO)
              .lte('date', endISO)
              .order('date');
            if (error) console.error(error);
            blackouts = blk || []
          } else blackouts = []
          banner.style.display = 'none'
        } catch {
          blackouts = []
          banner.textContent = 'Heads-up: listing_blackouts_daily view not found. Calendar works, but blackout dots won’t show until you add it.'
          banner.style.display = 'block'
        }

        try {
          const ids2 = getOwnedListingIds()
          if (ids2.length) {
            const { data: promos, error: pErr } = await supabase
              .from('listing_promotions')
              .select('id,listing_id,start_date,end_date,kind,tier1_value,tier2_value')
              .in('listing_id', ids2)
              .lte('start_date', endISO)
              .gte('end_date', startISO)
              .order('start_date')
            if (pErr) console.error(pErr)
            promotions = promos || []
          } else promotions = []
        } catch (e) {
          console.warn('Promo fetch failed (ok if table not present):', e)
          promotions = []
        }
      } else {
        myRentals = []; myLending = []; myListings = []; blackouts = []; promotions = []
      }
    }

    function seedYearSelect(){
      const now = new Date()
      const y0 = now.getFullYear() - 2
      const y1 = now.getFullYear() + 5
      const frag = document.createDocumentFragment()
      for (let y=y0; y<=y1; y++){
        const opt = document.createElement('option'); opt.value = String(y); opt.textContent = y
        frag.appendChild(opt)
      }
      jumpYear.innerHTML = ''; jumpYear.appendChild(frag)
    }

    function syncJumpControls(){
      jumpMonth.value = String(view.getMonth())
      jumpYear.value  = String(view.getFullYear())
    }

    function buildRunSegments(daySet, monthStartISO, monthEndISO){
      // returns map date -> {class,label}
      const days=[]
      for (let d=parseLocal(monthStartISO); d<=parseLocal(monthEndISO); d=addDays(d,1)){
        const isoS = toLocalISO(d)
        if (daySet.has(isoS)) days.push(isoS)
      }
      const segByDate = {}
      if (!days.length) return segByDate
      // group consecutive
      let run=[days[0]]
      for (let i=1;i<days.length;i++){
        const prev = parseLocal(days[i-1]), cur = parseLocal(days[i])
        if ((cur - prev)/(1000*60*60*24) === 1){ run.push(days[i]); continue }
        stampRun(run, segByDate); run=[days[i]]
      }
      stampRun(run, segByDate)
      return segByDate

      function stampRun(arr, out){
        const L = arr.length, mid = Math.floor((L-1)/2)
        for (let i=0;i<L;i++){
          let klass='run-mid'
          if (L===1) klass='run-solo'
          else if (i===0) klass='run-start'
          else if (i===L-1) klass='run-end'
          out[arr[i]] = { class:klass, labelIndex: i===mid }
        }
      }
    }

    function render() {
      const y=view.getFullYear(), m=view.getMonth()
      title.textContent = `${view.toLocaleString(undefined,{month:'long'})} ${y}`
      syncJumpControls()

      gridDays.innerHTML = ''

      const firstDow = new Date(y,m,1).getDay()
      const total = daysInMonth(view)

      // pad
      for (let i=0;i<firstDow;i++){
        const pad = document.createElement('div'); pad.className='day past'; gridDays.appendChild(pad)
      }

      // aggregate blackouts by kind into day sets (shop-wide view)
      const ownerDays = new Set(), storeDays = new Set()
      for (const b of blackouts) {
        if (b.kind === 'owner_unavailable') ownerDays.add(b.date)
        if (b.kind === 'store_blocked') storeDays.add(b.date)
      }
      const monthStartISO = iso(y,m,1), monthEndISO = iso(y,m,total)
      const ownerSeg = buildRunSegments(ownerDays, monthStartISO, monthEndISO)
      const storeSeg = buildRunSegments(storeDays, monthStartISO, monthEndISO)

      // precompute promos per day with run classes and a centered label
      const promoSegByDate = {}
      {
        for (const p of promotions){
          const ps = p.start_date.slice(0,10)
          const pe = p.end_date.slice(0,10)
          const start = parseLocal(ps) < parseLocal(monthStartISO) ? parseLocal(monthStartISO) : parseLocal(ps)
          const end   = parseLocal(pe) > parseLocal(monthEndISO)   ? parseLocal(monthEndISO)   : parseLocal(pe)
          if (end < start) continue
          const days=[]
          for (let d=new Date(start); d<=end; d=addDays(d,1)) days.push(toLocalISO(d))
          const L = days.length, midIdx = Math.floor((L-1)/2)
          const label = p.kind==='percent' ? `${p.tier1_value ?? ''}% off` : `$${p.tier1_value ?? ''} off`
          for (let i=0;i<L;i++){
            const dISO = days[i]
            if (promoSegByDate[dISO]) continue
            let klass = 'promo-run-mid'
            if (L===1) klass='promo-run-solo'
            else if (i===0) klass='promo-run-start'
            else if (i===L-1) klass='promo-run-end'
            promoSegByDate[dISO] = { class: klass, label: i===midIdx ? label : '' }
          }
        }
      }

      const today = new Date(); today.setHours(0,0,0,0)
      const todayISO = toLocalISO(today)

      for (let day=1; day<=total; day++){
        const dISO = iso(y,m,day)
        const cell = document.createElement('div'); cell.className='day'; cell.dataset.date=dISO

        const thisDay = new Date(y,m,day); thisDay.setHours(0,0,0,0)
        if (thisDay < today) cell.classList.add('past')
        if (dISO === todayISO) cell.classList.add('today')
        if (selection.has(dISO)) cell.classList.add('sel')

        const dateEl = document.createElement('div'); dateEl.className='date'; dateEl.textContent = day
        cell.appendChild(dateEl)

        /* ---------- lender summary counts per day ---------- */
        const chips = document.createElement('div'); chips.className='chips'
        if (filters.lend){
          const lendStart = myLending.filter(r => r.start_date_iso===dISO)
          const lendEnd   = myLending.filter(r => r.end_date_iso===dISO)

          const toDeliver = lendStart.filter(r => !!r.requires_delivery).length
          const toHandoff = lendStart.length - toDeliver

          const rtnPickup = lendEnd.filter(r => !!r.requires_delivery).length   // we must pick up from renter
          const rtnAtShop = lendEnd.length - rtnPickup                          // they return to us

          const addSum = (n, css, text) => {
            if (!n) return
            const chip = document.createElement('div')
            chip.className = `chip chip-sum ${css}`
            chip.textContent = n === 1 ? `1 ${text}` : `${n} ${text}s`
            chips.appendChild(chip)
          }
          addSum(toDeliver, 'l-deliver', 'to deliver')
          addSum(toHandoff, 'l-handoff', 'handoff')
          addSum(rtnPickup, 'l-rtn-pu', 'return pickup')
          addSum(rtnAtShop, 'l-rtn-due', 'return due')
        }

        /* ---------- renter edge summaries (compact) ---------- */
        if (filters.rent){
          const rentStart = myRentals.filter(r => r.start_date_iso===dISO).length
          const rentEnd   = myRentals.filter(r => r.end_date_iso===dISO).length
          const mk = (n, klass, word) => {
            if (!n) return
            const c = document.createElement('div'); c.className = `chip ${klass}`
            c.textContent = n === 1 ? `Your ${word}` : `Your ${word}s (${n})`
            chips.appendChild(c)
          }
          mk(rentStart, 'chip-rent-start', 'pickup')
          mk(rentEnd,   'chip-rent-end',   'return')
        }

        /* ---------- blackout bars (connected runs with centered label) ---------- */
        const os = ownerSeg[dISO], ss = storeSeg[dISO]
        if (filters.owner && os){
          const lane = document.createElement('div'); lane.className='blk-lane'
          const strip = document.createElement('div'); strip.className=`blk-strip blk-owner ${os.class}`
          if (os.labelIndex){ strip.innerHTML = `<div class="bar-label">Owner unavailable</div>` }
          lane.appendChild(strip); cell.appendChild(lane)
        }
        if (filters.store && ss){
          const lane = document.createElement('div'); lane.className='blk-lane'
          lane.style.top = '40px' // second lane below owner-unavailable
          const strip = document.createElement('div'); strip.className=`blk-strip blk-store ${ss.class}`
          if (ss.labelIndex){ strip.innerHTML = `<div class="bar-label">Store blocked</div>` }
          lane.appendChild(strip); cell.appendChild(lane)
        }

        /* ---------- promo lane ---------- */
        const seg = promoSegByDate[dISO]
        if (seg){
          const lane = document.createElement('div'); lane.className='promo-lane'
          const strip = document.createElement('div'); strip.className='promo-strip ' + seg.class
          if (seg.label) strip.innerHTML = `<div class="promo-label">${seg.label}</div>`
          lane.appendChild(strip); cell.appendChild(lane)
        }

        cell.appendChild(chips)
        gridDays.appendChild(cell)
      }

      updateAgenda()
    }

    // selection (owners/admin only)
    gridDays.addEventListener('click', (e)=>{
      const cell = e.target.closest('.day'); if (!cell) return
      const d = cell.dataset.date; if (!d) return
      if (!(isLender || isAdmin)) return
      if (selection.has(d)) { selection.delete(d); cell.classList.remove('sel') }
      else { selection.add(d); cell.classList.add('sel') }
      updateAgenda()
    })
    $('#btn-clear').addEventListener('click', ()=>{
      selection.clear()
      gridDays.querySelectorAll('.day.sel').forEach(el=>el.classList.remove('sel'))
      updateAgenda()
    })

    /* agenda helpers */
    function isConsecutive(sortedISO) {
      for (let i=1;i<sortedISO.length;i++){
        const prev = parseLocal(sortedISO[i-1])
        const cur  = parseLocal(sortedISO[i])
        const diff = (cur - prev) / (1000*60*60*24)
        if (diff !== 1) return false
      }
      return true
    }
    function datesForPeekWeek() {
      const t = new Date(); t.setHours(0,0,0,0)
      const arr = []
      for (let i=0;i<7;i++) arr.push(toLocalISO(addDays(t,i)))
      return arr
    }
    function expandRange(a,b){
      const out=[]
      for (let d=parseLocal(a); d<=parseLocal(b); d=addDays(d,1)) out.push(toLocalISO(d))
      return out
    }

    function updateAgenda(){
      let selected = Array.from(selection).sort()
      let dates, heading, subline

      if (!selected.length){
        dates = datesForPeekWeek()
        heading = 'A peek at the week'
        subline = `${fmtHuman(dates[0])} → ${fmtHuman(dates[dates.length-1])}`
      } else if (selected.length === 1){
        dates = selected
        heading = `Now viewing ${fmtHuman(selected[0])}`
        subline = ''
      } else {
        if (isConsecutive(selected)) {
          dates = expandRange(selected[0], selected[selected.length-1])
          heading = `Now viewing ${fmtHuman(selected[0])} → ${fmtHuman(selected[selected.length-1])}`
          subline = ''
        } else {
          dates = selected
          heading = 'Multiple non-consecutive dates selected'
          subline = `Dates: ${selected.map(fmtHuman).join(', ')}`
        }
      }

      agendaTitle.textContent = heading
      agendaSub.textContent = subline
      agendaList.innerHTML = ''

      const add = (txt) => { const li=document.createElement('li'); li.textContent=txt; agendaList.appendChild(li) }

      for (const dISO of dates){
        if (filters.rent){
          for (const r of myRentals) {
            if (sameDay(r.start_date_iso, dISO)) {
              const t = timeHuman(r.start_time)
              add(`Your rental • ${r.listings?.title || `Listing #${r.listing_id}`} (pickup${t?` at ${t}`:''}) • ${fmtHuman(dISO)}`)
            }
            if (sameDay(r.end_date_iso, dISO)) {
              const t = timeHuman(r.end_time)
              add(`Your rental • ${r.listings?.title || `Listing #${r.listing_id}`} (return${t?` at ${t}`:''}) • ${fmtHuman(dISO)}`)
            }
          }
        }

        if (filters.lend){
          for (const r of myLending) {
            if (sameDay(r.start_date_iso, dISO)) {
              const t = timeHuman(r.start_time)
              add(`Lender obligation • ${r.listings?.title || `Listing #${r.listing_id}`} (${r.requires_delivery ? 'deliver' : 'handoff'}${t?` at ${t}`:''}) • ${fmtHuman(dISO)}`)
            }
            if (sameDay(r.end_date_iso, dISO)) {
              const t = timeHuman(r.end_time)
              add(`Lender obligation • ${r.listings?.title || `Listing #${r.listing_id}`} (${r.requires_delivery ? 'pick up return' : 'receive return'}${t?` at ${t}`:''}) • ${fmtHuman(dISO)}`)
            }
          }
        }

        const ownerOn = blackouts.some(b => b.date===dISO && b.kind==='owner_unavailable')
        const storeOn = blackouts.some(b => b.date===dISO && b.kind==='store_blocked')
        if (ownerOn && filters.owner) add(`Owner unavailable • ${fmtHuman(dISO)}`)
        if (storeOn && filters.store)  add(`Store blocked • ${fmtHuman(dISO)}`)

        for (const p of promotions) {
          const dd = parseLocal(dISO), ps = parseLocal(p.start_date), pe = parseLocal(p.end_date)
          if (dd >= ps && dd <= pe) {
            const label = p.kind==='percent' ? `${p.tier1_value ?? ''}% off` : `$${p.tier1_value ?? ''} off`
            add(`Promotion active • ${label} • ${fmtHuman(dISO)}`)
          }
        }
      }
    }

    // month navigation (buttons)
    prevBtn.addEventListener('click', ()=>{ view.setMonth(view.getMonth()-1); refresh() })
    nextBtn.addEventListener('click', ()=>{ view.setMonth(view.getMonth()+1); refresh() })

    // jump selects (instant navigation)
    function onJumpChange(){
      const y = parseInt(jumpYear.value,10)
      const m = parseInt(jumpMonth.value,10)
      if (!Number.isNaN(y) && !Number.isNaN(m)) { view = new Date(y, m, 1); refresh() }
    }
    jumpMonth.addEventListener('change', onJumpChange)
    jumpYear.addEventListener('change', onJumpChange)
    jumpToday.addEventListener('click', ()=>{
      const t = new Date(); view = new Date(t.getFullYear(), t.getMonth(), 1); refresh()
    })

    // keyboard
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowLeft'){ view.setMonth(view.getMonth()-1); refresh() }
      else if (e.key === 'ArrowRight'){ view.setMonth(view.getMonth()+1); refresh() }
      else if (e.key === 'Home'){ const t=new Date(); view = new Date(t.getFullYear(), t.getMonth(), 1); refresh() }
    })

    // change-limit guard
    function withinChangeWindow(dISO){
      const today = new Date(); today.setHours(0,0,0,0)
      const limit = addMonths(today, MAX_CHANGE_MONTHS)
      return parseLocal(dISO) <= new Date(limit.getFullYear(), limit.getMonth()+1, 0)
    }
    function guardSelectionWithinWindow(){
      if (!selection.size) return true
      const bad = Array.from(selection).some(d => !withinChangeWindow(d))
      if (bad){ alert(`Edits are limited to ${MAX_CHANGE_MONTHS} months ahead. Viewing is fine; bulk rules will apply beyond.`); return false }
      return true
    }

    // utilities: selection → consecutive ranges
    function selectionRanges(){
      const arr = Array.from(selection).sort()
      if (!arr.length) return []
      const out=[]
      let start = arr[0], prev = arr[0]
      for (let i=1;i<arr.length;i++){
        const cur = arr[i]
        const diff = (parseLocal(cur) - parseLocal(prev)) / (1000*60*60*24)
        if (diff === 1) { prev = cur; continue }
        out.push([start, prev]); start = cur; prev = cur
      }
      out.push([start, prev])
      return out
    }

    function ownedIds(){ return (myListings || []).map(l => l.id) }

    // ----- Shop-wide blackout ops (duplicate-aware) -----
    async function upsertBlackout(kind) {
      if (!selection.size) { alert('Select one or more dates on the calendar.'); return }
      if (!guardSelectionWithinWindow()) return

      const ids = ownedIds()
      if (!ids.length) { alert('No listings available.'); return }

      const selectedDates = Array.from(selection).sort()

      try {
        const { data: existing, error: exErr } = await supabase
          .from('listing_blackouts')
          .select('listing_id,start_date,kind')
          .in('listing_id', ids)
          .in('start_date', selectedDates)
          .eq('kind', kind)
        if (exErr) console.warn('Duplicate check error:', exErr)

        const existingSet = new Set((existing || []).map(r => `${r.listing_id}_${r.start_date}_${r.kind}`))
        const rows = []
        for (const id of ids) for (const d of selectedDates) {
          const key = `${id}_${d}_${kind}`
          if (!existingSet.has(key)) rows.push({ listing_id:id, start_date:d, end_date:d, kind })
        }

        if (!rows.length) {
          alert('One or more selected dates are already marked for that blackout type. Nothing to add.')
        } else {
          const { error } = await supabase
            .from('listing_blackouts')
            .upsert(rows, { onConflict:'listing_id,start_date,end_date,kind' })
          if (error) throw error
          alert('Blackout(s) saved. Existing dates were ignored.')
        }
      } catch (e) {
        console.error(e); alert('Could not save blackout: ' + (e?.message || e))
        return
      }

      selection.clear()
      await loadMonthData(); render()
    }

    async function removeBlackout(kind) {
      if (!selection.size) { alert('Select one or more dates on the calendar.'); return }
      if (!guardSelectionWithinWindow()) return

      const ids = ownedIds()
      if (!ids.length) { alert('No listings available.'); return }
      const dates = Array.from(selection).sort()
      try {
        await supabase.from('listing_blackouts')
          .delete()
          .in('listing_id', ids)
          .in('start_date', dates)
          .eq('kind', kind)

        selection.clear()
        await loadMonthData(); render()
        alert('Removed blackout entries for the selected dates.')
      } catch (e) {
        console.error(e); alert('Could not remove entries: ' + (e?.message || e))
      }
    }

    $('#btn-unavail-add').addEventListener('click',  ()=>upsertBlackout('owner_unavailable'))
    $('#btn-unavail-remove').addEventListener('click',()=>removeBlackout('owner_unavailable'))
    $('#btn-block-add').addEventListener('click',     ()=>upsertBlackout('store_blocked'))
    $('#btn-block-remove').addEventListener('click',  ()=>removeBlackout('store_blocked'))

    // ----- Promotions -----
    const promoModal = $('#promo-modal')
    $('#btn-promo-add').addEventListener('click', ()=>{
      const y = view.getFullYear(), m = view.getMonth()
      const dates = Array.from(selection).sort()
      const start = dates[0] || iso(y,m,1)
      const end   = dates[dates.length-1] || iso(y,m,daysInMonth(view))
      $('#promo-start').value = start
      $('#promo-end').value = end
      promoModal.showModal()
    })
    $('#promo-cancel').addEventListener('click', ()=>promoModal.close())

    $('#promo-save').addEventListener('click', async ()=>{
      try {
        const type  = $('#promo-type').value
        const start = $('#promo-start').value
        const end   = $('#promo-end').value

        const today = new Date(); today.setHours(0,0,0,0)
        const limEnd = new Date(addMonths(today, MAX_CHANGE_MONTHS).getFullYear(), addMonths(today, MAX_CHANGE_MONTHS).getMonth()+1, 0)
        if (parseLocal(end) > limEnd) return alert(`Promotions cannot be saved beyond ${MAX_CHANGE_MONTHS} months ahead.`)

        const t1v   = parseFloat($('#t1-value').value) || null
        const t1min = parseInt($('#t1-min').value,10) || null
        const t1max = parseInt($('#t1-max').value,10) || null
        const t2v   = parseFloat($('#t2-value').value) || null
        const t2min = parseInt($('#t2-min').value,10) || null
        const t2max = parseInt($('#t2-max').value,10) || null

        if (!start || !end) return alert('Choose a promo date range.')

        const ids = (myListings||[]).map(l => l.id)
        if (!ids.length) return alert('No listings available.')

        // replace overlapping promos for these listings+range
        await supabase.from('listing_promotions')
          .delete()
          .in('listing_id', ids)
          .lte('start_date', end)
          .gte('end_date', start)

        const rows = ids.map(id => ({
          listing_id: id,
          kind: type,
          tier1_value: t1v,
          tier1_min_days: t1min,
          tier1_max_days: t1max,
          tier2_value: t2v,
          tier2_min_days: t2min,
          tier2_max_days: t2max,
          start_date: start,
          end_date: end
        }))
        const { error } = await supabase.from('listing_promotions').insert(rows)
        if (error) throw error

        promoModal.close()
        alert('Promotional pricing saved.')
        await loadMonthData(); render()
      } catch (e) {
        console.warn('Promo save failed (OK to ignore if table not present):', e)
        alert('Could not save promo. Ensure the listing_promotions table schema/policies are in place.')
      }
    })

    // Trim/remove promotions in selected ranges (split/shorten)
    async function trimPromotionsInRanges(){
      if (!selection.size) return alert('Select one or more dates to trim/remove promotions.')
      if (!guardSelectionWithinWindow()) return
      const ids = (myListings||[]).map(l => l.id)
      if (!ids.length) return alert('No listings available.')
      const ranges = (()=>{ const arr=[...selection].sort(); if(!arr.length) return []; const out=[]; let s=arr[0], p=arr[0]; for(let i=1;i<arr.length;i++){ const c=arr[i]; const diff=(parseLocal(c)-parseLocal(p))/(1000*60*60*24); if(diff===1){ p=c; continue } out.push([s,p]); s=c; p=c } out.push([s,p]); return out })()
      try {
        for (const [ss,se] of ranges){
          const { data: promos } = await supabase
            .from('listing_promotions')
            .select('id,listing_id,start_date,end_date,kind,tier1_value,tier1_min_days,tier1_max_days,tier2_value,tier2_min_days,tier2_max_days')
            .in('listing_id', ids)
            .lte('start_date', se)
            .gte('end_date', ss)

          for (const p of (promos||[])){
            const ps = p.start_date.slice(0,10), pe = p.end_date.slice(0,10)
            if (ss <= ps && se >= pe){ await supabase.from('listing_promotions').delete().eq('id', p.id); continue }
            if (ss > ps && se < pe){
              await supabase.from('listing_promotions').update({ end_date: addDaysISO(ss, -1) }).eq('id', p.id)
              const rightStart = addDaysISO(se, 1)
              await supabase.from('listing_promotions').insert({
                listing_id: p.listing_id, kind: p.kind,
                tier1_value:p.tier1_value, tier1_min_days:p.tier1_min_days, tier1_max_days:p.tier1_max_days,
                tier2_value:p.tier2_value, tier2_min_days:p.tier2_min_days, tier2_max_days:p.tier2_max_days,
                start_date: rightStart, end_date: pe
              })
              continue
            }
            if (ss <= ps && se < pe && se >= ps){ const newStart = addDaysISO(se, 1); await supabase.from('listing_promotions').update({ start_date: newStart }).eq('id', p.id); continue }
            if (ss > ps && ss <= pe && se >= pe){ const newEnd = addDaysISO(ss, -1); await supabase.from('listing_promotions').update({ end_date: newEnd }).eq('id', p.id); continue }
          }
        }
        selection.clear()
        await loadMonthData(); render()
        alert('Promotions trimmed.')
      } catch (e) {
        console.error(e); alert('Could not trim promotions: ' + (e?.message || e))
      }
    }
    $('#btn-promo-remove').addEventListener('click', trimPromotionsInRanges)

    async function refresh(){ await loadMonthData(); render() }

    // allow ?focus=YYYY-MM-DD and ?listing=<id>
    const focus = params.get('focus')
    if (focus && /^\d{4}-\d{2}-\d{2}$/.test(focus)) {
      const f = parseLocal(focus)
      if (!Number.isNaN(f.getTime())) view = new Date(f.getFullYear(), f.getMonth(), 1)
    }

    seedYearSelect()
    syncJumpControls()
    await refresh()
    supabase.auth.onAuthStateChange(async ()=>{ await refresh() })
  </script>

  <script src="script.js" defer></script>
</body>
</html>
