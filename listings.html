<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BARO • Listings</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .page-intro { text-align:center; padding: 2rem 1rem; }
    .page-intro h2 { margin: 0 0 .25rem 0; }
    .page-intro p  { margin: 0; opacity: .85; }
    .note { text-align:center; padding:0.75rem; }
    .card img { width:100%; height:180px; object-fit:cover; border-radius:10px; margin-bottom:.5rem; }
    .muted { opacity:.8; font-size:.95rem; }
  </style>
</head>
<body>
  <!-- Shared site header -->
  <div id="header"></div>
  <script>
    (async () => {
      const mount = document.getElementById('header');
      try {
        const res = await fetch('header.html', { cache: 'no-store' });
        mount.innerHTML = await res.text();
      } catch (e) {
        console.error('Failed to load header.html', e);
      }
      const boot = () => { if (window.initHero) window.initHero(); };
      if (document.readyState === 'complete') boot(); else window.addEventListener('load', boot);
    })();
  </script>

  <main>
    <section class="page-intro">
      <h2>All Listings</h2>
      <p>Select a listing to see details and availability.</p>
    </section>

    <section class="categories">
      <h3 style="text-align:center;">Browse Everything</h3>
      <div class="grid" id="listings-grid"></div>
    </section>
  </main>

  <footer><p>Servicing Location: Anchorage, AK</p><p>© 2025 Baro</p></footer>

  <!-- Load listings from Supabase -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://lxplphqfkdvjtphafcyt.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4cGxwaHFma2R2anRwaGFmY3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDAxOTQsImV4cCI6MjA3NTQxNjE5NH0.cRm0HrVuhEgALHiyOtlMQWMvDcFXFaBZvBOysshpzjU'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const grid = document.getElementById('listings-grid')

    // 1) Get only published listings
    const { data: listings, error: lerr } = await supabase
      .from('listings')
      .select('id, title, category, location_text, daily_price, published_at')
      .eq('published', true)
      .order('published_at', { ascending: false, nullsFirst: false })
      .order('created_at', { ascending: false })

    if (lerr) {
      const p = document.createElement('p')
      p.className = 'note'
      p.textContent = 'Error loading listings.'
      grid.parentElement.appendChild(p)
      throw lerr
    }
    if (!listings?.length) {
      const p = document.createElement('p')
      p.className = 'note'
      p.textContent = 'No listings yet.'
      grid.parentElement.appendChild(p)
    } else {
      // 2) Try to fetch cover photos from the view; fall back to first photo if view missing
      const ids = listings.map(l => l.id)
      const coverByListing = {}

      // Try the view first
      let hadCoverView = true
      {
        const { data: covers, error: cerr } = await supabase
          .from('listing_cover_photo')
          .select('listing_id, path')
          .in('listing_id', ids)

        if (cerr) {
          hadCoverView = false
        } else {
          for (const c of covers || []) coverByListing[c.listing_id] = c.path
        }
      }

      // Fallback: pull first/primary photo per listing
      if (!hadCoverView) {
        const { data: photos } = await supabase
          .from('listing_photos')
          .select('listing_id, path, is_primary, created_at')
          .in('listing_id', ids)
          .order('is_primary', { ascending: false })
          .order('created_at', { ascending: true })

        if (photos?.length) {
          const firstBy = {}
          for (const p of photos) {
            if (!firstBy[p.listing_id]) firstBy[p.listing_id] = p
          }
          for (const [lid, p] of Object.entries(firstBy)) coverByListing[lid] = p.path
        }
      }

      // Render cards
      for (const item of listings) {
        const a = document.createElement('a')
        a.className = 'card'
        a.href = `/listing.html?id=${encodeURIComponent(item.id)}`

        // resolve public image url if we have a path
        let imgHtml = ''
        const path = coverByListing[item.id]
        if (path) {
          const { data: pub } = supabase.storage.from('listing-photos').getPublicUrl(path)
          if (pub?.publicUrl) {
            imgHtml = `<img src="${pub.publicUrl}" alt="">`
          }
        }

        const price = (item.daily_price != null && !isNaN(item.daily_price))
          ? `$${Number(item.daily_price).toFixed(2)}/day`
          : '—'

        const loc = item.location_text ? `<span class="muted">${item.location_text}</span>` : ''
        const cat = item.category ? `<span class="muted">${item.category}</span>` : ''

        a.innerHTML = `
          ${imgHtml}
          <h4>${item.title || 'Untitled listing'}</h4>
          <p>${price}</p>
          <p>${loc}${loc && cat ? ' · ' : ''}${cat}</p>
        `
        grid.appendChild(a)
      }
    }
  </script>

  <script src="script.js" defer></script>
</body>
</html>
